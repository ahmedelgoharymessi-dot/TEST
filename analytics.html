<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø¬Ø§Ø³ÙˆØ³">
    <meta name="theme-color" content="#0a0e1a">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª | El Jasus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <link rel="icon" type="image/png" href="ElJasus2.png">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="mobile.css">
    <style>
        :root{--primary:#00f2ff;--secondary:#7c30ff;}
        body{font-family:'Cairo',sans-serif;background:linear-gradient(135deg,#0a0e1a 0%,#1a1535 50%,#0f0c1d 100%);
            background-attachment:fixed;color:#fff;min-height:100vh;overflow-x:hidden;}
        body::before{content:'';position:fixed;inset:0;
            background-image:linear-gradient(rgba(0,242,255,.03) 1px,transparent 1px),
            linear-gradient(90deg,rgba(0,242,255,.03) 1px,transparent 1px);
            background-size:50px 50px;animation:gridMove 20s linear infinite;pointer-events:none;z-index:0;}
        @keyframes gridMove{to{transform:translateY(50px);}}
        .glass{background:linear-gradient(135deg,rgba(15,20,35,.92),rgba(25,30,50,.85));
            backdrop-filter:blur(20px);border:2px solid;position:relative;overflow:hidden;
            border-image:linear-gradient(135deg,rgba(0,242,255,.3),rgba(124,48,255,.3)) 1;
            box-shadow:0 8px 32px rgba(0,0,0,.4);}
        .neon{font-family:'Orbitron',sans-serif;text-shadow:0 0 10px rgba(0,242,255,.8);}
        .stat-num{font-family:'Orbitron',sans-serif;font-size:2rem;font-weight:900;}
        canvas{max-height:240px;}
        .perf-bar{height:8px;border-radius:4px;background:rgba(255,255,255,.1);overflow:hidden;}
        .perf-fill{height:100%;border-radius:4px;transition:width 1s ease;}
        .report-tag{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:900;cursor:pointer;transition:all .2s;}
        .report-tag:hover{transform:scale(1.05);}
    </style>
</head>
<body class="p-4 has-mobile-nav">
<div class="max-w-6xl mx-auto relative z-10">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <a href="account.html" class="flex items-center gap-2 text-gray-400 hover:text-cyan-400 transition-all">
            <i class="fas fa-arrow-right text-xl"></i>
            <span class="text-sm font-bold">Ø±Ø¬ÙˆØ¹</span>
        </a>
        <div class="text-center">
            <h1 class="text-3xl font-black neon uppercase">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h1>
            <p style="font-family:'Orbitron',sans-serif;font-size:10px;color:#555;letter-spacing:3px;">ANALYTICS</p>
        </div>
        <div class="w-24"></div>
    </div>

    <!-- KPI Row -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="glass rounded-2xl p-5">
            <p class="text-xs text-gray-400 uppercase font-bold mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</p>
            <p id="kpi-total"   class="stat-num text-cyan-400">0</p>
        </div>
        <div class="glass rounded-2xl p-5">
            <p class="text-xs text-gray-400 uppercase font-bold mb-2">Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²</p>
            <p id="kpi-wr"      class="stat-num text-green-400">0%</p>
        </div>
        <div class="glass rounded-2xl p-5">
            <p class="text-xs text-gray-400 uppercase font-bold mb-2">Ø§Ù†ØªØµØ§Ø±Ø§Øª Ø¬Ø§Ø³ÙˆØ³</p>
            <p id="kpi-spy"     class="stat-num text-red-400">0</p>
        </div>
        <div class="glass rounded-2xl p-5">
            <p class="text-xs text-gray-400 uppercase font-bold mb-2">Ø£Ø·ÙˆÙ„ Ø³Ù„Ø³Ù„Ø©</p>
            <p id="kpi-streak"  class="stat-num text-orange-400">0</p>
        </div>
    </div>

    <!-- Charts row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

        <!-- Win distribution doughnut -->
        <div class="glass rounded-2xl p-6">
            <h3 class="neon text-lg font-black mb-4">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ù†ØªØµØ§Ø±Ø§Øª</h3>
            <canvas id="donutChart"></canvas>
            <div class="flex justify-center gap-6 mt-4 text-sm">
                <span class="flex items-center gap-2"><span style="width:12px;height:12px;border-radius:50%;background:#ef4444;display:inline-block;"></span> Ø¬Ø§Ø³ÙˆØ³</span>
                <span class="flex items-center gap-2"><span style="width:12px;height:12px;border-radius:50%;background:#22c55e;display:inline-block;"></span> Ø¨Ø±ÙŠØ¡</span>
                <span class="flex items-center gap-2"><span style="width:12px;height:12px;border-radius:50%;background:#6b7280;display:inline-block;"></span> Ø®Ø³Ø§Ø±Ø©</span>
            </div>
        </div>

        <!-- Performance per category bar chart -->
        <div class="glass rounded-2xl p-6">
            <h3 class="neon text-lg font-black mb-4">Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>
            <canvas id="catChart"></canvas>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="glass rounded-2xl p-6 mb-6">
        <h3 class="neon text-lg font-black mb-5">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
        <div class="space-y-5" id="perf-metrics"></div>
    </div>

    <!-- Game History -->
    <div class="glass rounded-2xl p-6 mb-6">
        <h3 class="neon text-lg font-black mb-4">Ø¢Ø®Ø± 10 Ù…Ø¨Ø§Ø±ÙŠØ§Øª</h3>
        <div id="history-list" class="space-y-3"></div>
    </div>

    <!-- Report a Player Section -->
    <div class="glass rounded-2xl p-6" style="border-image:linear-gradient(135deg,rgba(239,68,68,.4),rgba(239,68,68,.1)) 1;">
        <div class="flex items-center gap-3 mb-5">
            <div class="w-12 h-12 rounded-xl bg-red-500/20 border-2 border-red-500/30 flex items-center justify-center">
                <i class="fas fa-flag text-red-400 text-xl"></i>
            </div>
            <div>
                <h3 class="text-lg font-black text-red-400">Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù„Ø§Ø¹Ø¨</h3>
                <p class="text-xs text-gray-400">Ù„Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø¨ÙŠØ¦Ø© Ù„Ø¹Ø¨ ØµØ­ÙŠØ©</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="text-sm font-bold text-gray-400 block mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input id="report-username" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨"
                    class="w-full p-3 rounded-xl bg-white/5 border-2 border-red-500/20 text-white outline-none"
                    style="font-family:'Cairo',sans-serif;">
            </div>
            <div>
                <label class="text-sm font-bold text-gray-400 block mb-2">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="report-room" type="text" placeholder="XXXXXX"
                    class="w-full p-3 rounded-xl bg-white/5 border-2 border-red-500/20 text-white outline-none"
                    style="font-family:'Cairo',sans-serif;">
            </div>
        </div>

        <div class="mt-4">
            <label class="text-sm font-bold text-gray-400 block mb-3">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº</label>
            <div class="flex flex-wrap gap-2" id="reason-tags">
                <span class="report-tag bg-red-500/20 border-2 border-red-500/30 text-red-300" onclick="selectReason(this,'cheating')">ğŸ¯ ØºØ´</span>
                <span class="report-tag bg-orange-500/20 border-2 border-orange-500/30 text-orange-300" onclick="selectReason(this,'spam')">ğŸ’¬ Ø³Ø¨Ø§Ù…</span>
                <span class="report-tag bg-yellow-500/20 border-2 border-yellow-500/30 text-yellow-300" onclick="selectReason(this,'harassment')">ğŸ˜  ØªØ­Ø±Ø´</span>
                <span class="report-tag bg-purple-500/20 border-2 border-purple-500/30 text-purple-300" onclick="selectReason(this,'offensive')">ğŸ¤¬ Ù…Ø­ØªÙˆÙ‰ Ù…Ø³ÙŠØ¡</span>
                <span class="report-tag bg-blue-500/20 border-2 border-blue-500/30 text-blue-300" onclick="selectReason(this,'other')">â“ Ø£Ø®Ø±Ù‰</span>
            </div>
        </div>

        <div class="mt-4">
            <label class="text-sm font-bold text-gray-400 block mb-2">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</label>
            <textarea id="report-desc" rows="3" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§..."
                class="w-full p-3 rounded-xl bg-white/5 border-2 border-red-500/20 text-white outline-none resize-none"
                style="font-family:'Cairo',sans-serif;"></textarea>
        </div>

        <button onclick="submitReport()" class="mt-4 px-8 py-3 rounded-xl font-black text-sm uppercase"
            style="background:linear-gradient(135deg,#ef4444,#dc2626);box-shadow:0 0 20px rgba(239,68,68,.4);">
            <i class="fas fa-flag ml-2"></i>
            Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº
        </button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, push, set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";


const firebaseConfig = {
  apiKey: "AIzaSyDnd-pmKEatI3DaFz6xHWB5ucurtHXt9tk",
  authDomain: "el-jasus.firebaseapp.com",
  databaseURL: "https://el-jasus-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "el-jasus",
  storageBucket: "el-jasus.firebasestorage.app",
  messagingSenderId: "415659587906",
  appId: "1:415659587906:web:782f7940176ea4097eb0db",
  measurementId: "G-N4K79FP56N"
};


const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

let currentUser = null;
let selectedReason = '';
let userData = {};

window.selectReason = (el, reason) => {
    document.querySelectorAll('.report-tag').forEach(t => t.style.fontWeight = '700');
    el.style.fontWeight = '900'; el.style.boxShadow = '0 0 12px currentColor';
    selectedReason = reason;
};

window.submitReport = async () => {
    const username = document.getElementById('report-username').value.trim();
    const room     = document.getElementById('report-room').value.trim();
    const desc     = document.getElementById('report-desc').value.trim();

    if (!username) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); return; }
    if (!selectedReason) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¨Ø¨ Ø§Ù„Ø¨Ù„Ø§Øº'); return; }

    await push(ref(db, 'reports'), {
        reportedUsername: username,
        reportedBy: currentUser.uid,
        reportedByUsername: currentUser.displayName || 'Ù…Ø¬Ù‡ÙˆÙ„',
        reason: selectedReason,
        description: desc,
        roomCode: room || null,
        timestamp: Date.now(),
        status: 'pending'
    });

    alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº. Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙ†Ø§ ÙÙŠ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¨ÙŠØ¦Ø© Ù„Ø¹Ø¨ Ø¬ÙŠØ¯Ø©!');
    document.getElementById('report-username').value = '';
    document.getElementById('report-room').value = '';
    document.getElementById('report-desc').value = '';
    selectedReason = '';
    document.querySelectorAll('.report-tag').forEach(t => t.style.boxShadow = '');
};

// â”€â”€ LOAD ANALYTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, async user => {
    if (!user) { window.location.href='login.html'; return; }
    currentUser = user;
    const snap = await get(ref(db, `players/${user.uid}`));
    if (!snap.exists()) return;
    userData = snap.val();
    const stats = userData.stats || {};
    renderKPIs(stats);
    renderCharts(stats, userData.categoryStats || {});
    renderPerfMetrics(stats);
    renderHistory(userData.gameHistory || []);
});

function renderKPIs(s) {
    const total = s.totalGames || 0;
    const wins  = (s.spyWins||0) + (s.innocentWins||0);
    document.getElementById('kpi-total').textContent  = total;
    document.getElementById('kpi-wr').textContent     = total ? Math.round(wins/total*100)+'%' : '0%';
    document.getElementById('kpi-spy').textContent    = s.spyWins || 0;
    document.getElementById('kpi-streak').textContent = s.longestWinStreak || 0;
}

function renderCharts(s, cats) {
    // Donut
    const total  = s.totalGames || 1;
    const spy    = s.spyWins || 0;
    const inno   = s.innocentWins || 0;
    const loss   = total - spy - inno;

    new Chart(document.getElementById('donutChart'), {
        type: 'doughnut',
        data: { labels:['Ø¬Ø§Ø³ÙˆØ³','Ø¨Ø±ÙŠØ¡','Ø®Ø³Ø§Ø±Ø©'], datasets:[{
            data:[spy,inno,Math.max(loss,0)],
            backgroundColor:['#ef4444','#22c55e','#374151'],
            borderColor:'transparent', hoverOffset:8
        }]},
        options:{ plugins:{ legend:{ display:false } }, cutout:'70%',
            responsive:true, animation:{ animateRotate:true, duration:1200 }}
    });

    // Category bar
    const labels = Object.keys(cats).slice(0,6);
    const values = labels.map(k=>cats[k]);
    new Chart(document.getElementById('catChart'), {
        type:'bar',
        data:{ labels, datasets:[{
            label:'Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª',
            data:values,
            backgroundColor:'rgba(0,242,255,.3)',
            borderColor:'#00f2ff',
            borderWidth:2, borderRadius:8
        }]},
        options:{
            plugins:{ legend:{display:false} },
            scales:{
                x:{ ticks:{ color:'#aaa', font:{family:'Cairo'} }, grid:{ color:'rgba(255,255,255,.05)' } },
                y:{ ticks:{ color:'#aaa' }, grid:{ color:'rgba(255,255,255,.05)' } }
            },
            responsive:true
        }
    });
}

function renderPerfMetrics(s) {
    const metrics = [
        { label:'Ù…Ø¹Ø¯Ù„ ÙƒØ´Ù Ø§Ù„Ø¬Ø§Ø³ÙˆØ³', val: s.spyDetectionRate||0, max:100, color:'#00f2ff', suffix:'%' },
        { label:'Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙÙˆØ² ÙƒØ¬Ø§Ø³ÙˆØ³', val: s.totalGames ? Math.round((s.spyWins||0)/Math.max(s.spyGames||1,1)*100):0, max:100, color:'#ef4444', suffix:'%' },
        { label:'Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙÙˆØ² ÙƒØ¨Ø±ÙŠØ¡',  val: s.totalGames ? Math.round((s.innocentWins||0)/Math.max((s.totalGames||1)-(s.spyGames||0),1)*100):0, max:100, color:'#22c55e', suffix:'%' },
    ];
    document.getElementById('perf-metrics').innerHTML = metrics.map(m => `
        <div>
            <div class="flex justify-between mb-2">
                <span class="text-sm font-bold">${m.label}</span>
                <span style="font-family:'Orbitron',sans-serif;color:${m.color};font-size:13px;font-weight:900;">${m.val}${m.suffix}</span>
            </div>
            <div class="perf-bar">
                <div class="perf-fill" style="width:${Math.min(m.val,100)}%;background:${m.color};"></div>
            </div>
        </div>`).join('');
}

function renderHistory(history) {
    const list = document.getElementById('history-list');
    if (!history.length) { list.innerHTML='<p class="text-gray-400 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p>'; return; }
    list.innerHTML = [...history].reverse().slice(0,10).map(g => `
        <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5">
            <div class="flex items-center gap-3">
                <span style="font-size:20px;">${g.role==='spy'?'ğŸ•µï¸':'ğŸ›¡ï¸'}</span>
                <div>
                    <p class="font-bold text-sm">${g.category || 'Ø¹Ø§Ù…'}</p>
                    <p class="text-xs text-gray-400">${new Date(g.timestamp).toLocaleDateString('ar-SA')}</p>
                </div>
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-bold
                ${g.won?'bg-green-500/20 text-green-400 border border-green-500/30':'bg-red-500/20 text-red-400 border border-red-500/30'}">
                ${g.won?'ÙÙˆØ²':'Ø®Ø³Ø§Ø±Ø©'}
            </span>
        </div>`).join('');
}
</script>
    <link rel="stylesheet" href="mobile.css">
    <script src="sound-system.js" defer></script>
    <script src="qr-notifications.js" defer></script>
    <script>if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(()=>{}));}</script>
</body>
</html>
