<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุบุฑูุฉ | El Jasus</title>
    <!-- EL JASUS NEW FEATURES -->
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile.css">
    <script src="particles.js" defer></script>
    <script src="sound-system.js" defer></script>
    <script src="qr-notifications.js" defer></script>
    <script src="emoji-reactions.js" defer></script>
    <script src="voice-chat.js" defer></script>
    <script src="screenshot.js" defer></script>
    <script src="moderation.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="ElJasus2.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { 
            --bg-color: #0a0e1a;
            --card-color: rgba(15, 20, 35, 0.95);
            --btn-color: #00f2ff;
            --text-color: #ffffff;
            --accent-color: #00f2ff;
            --secondary-color: #7c30ff;
        }
        
        body { 
            font-family: 'Cairo', sans-serif; 
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1535 50%, #0f0c1d 100%);
            background-attachment: fixed;
            color: var(--text-color); 
            min-height: 100vh; 
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gridMove {
            0% { transform: translateY(0); }
            100% { transform: translateY(50px); }
        }
        
        .glass { 
            background: linear-gradient(135deg, rgba(15, 20, 35, 0.9), rgba(25, 30, 50, 0.8));
            backdrop-filter: blur(20px);
            border: 2px solid;
            border-image: linear-gradient(135deg, rgba(0, 242, 255, 0.3), rgba(124, 48, 255, 0.3)) 1;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 30px rgba(0, 242, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .glass::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(0, 242, 255, 0.05),
                transparent
            );
            animation: shimmer 3s infinite;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .dynamic-text-primary { 
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
            font-family: 'Orbitron', sans-serif;
        }
        
        .dynamic-bg-primary { 
            background: linear-gradient(135deg, var(--btn-color), var(--secondary-color));
            color: #ffffff;
            box-shadow: 
                0 4px 15px rgba(0, 242, 255, 0.4),
                inset 0 -2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .btn-main { 
            background: linear-gradient(135deg, var(--btn-color), var(--secondary-color));
            color: #ffffff;
            font-weight: 900;
            border: 2px solid rgba(0, 242, 255, 0.5);
            box-shadow: 
                0 0 20px rgba(0, 242, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .btn-main:hover { 
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 0 30px rgba(0, 242, 255, 0.6),
                0 8px 20px rgba(0, 242, 255, 0.3);
        }

        .reveal-innocent {
            background: linear-gradient(145deg, #065f46, #059669) !important;
            border-color: #34d399 !important;
            box-shadow: 0 0 40px rgba(52, 211, 153, 0.5);
            animation: flipInY 0.6s;
        }

        .reveal-spy {
            background: linear-gradient(145deg, #7f1d1d, #dc2626) !important;
            border-color: #f87171 !important;
            box-shadow: 0 0 40px rgba(248, 113, 113, 0.5);
            animation: shakeX 0.5s;
        }

        /* โโ Scrollbar styles โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ */
        /* Page-level scrollbar (browser default, left side in RTL) โ untouched */

        /* Players list internal scrollbar โ styled, slightly wider */
        .custom-scrollbar::-webkit-scrollbar { width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { 
            background: rgba(0, 242, 255, 0.05);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, var(--accent-color), var(--secondary-color));
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #33f5ff, #9b59ff);
        }
        /* Firefox */
        .custom-scrollbar { scrollbar-width: thin; scrollbar-color: var(--accent-color) rgba(0,242,255,0.05); }

        .fa-crown {
            color: #ffd700;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
        }

        .neon-text {
            font-family: 'Orbitron', sans-serif;
            text-shadow: 
                0 0 10px rgba(0, 242, 255, 0.8),
                0 0 20px rgba(0, 242, 255, 0.6);
        }
    </style>
</head>
<body class="p-4">

    <!-- Game Screen (Turn-based reveal) -->
    <div id="game-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
        <div class="max-w-md w-full">
            <div class="text-center mb-6">
                <p class="text-[11px] dynamic-text-primary font-black uppercase tracking-widest mb-2" style="font-family: 'Orbitron', sans-serif;">ุฏูุฑ ุงููุงุนุจ</p>
                <h3 id="targetPlayer" class="text-4xl font-black neon-text">---</h3>
            </div>
            <div id="secretCard" class="h-96 glass rounded-[2.5rem] border-2 border-dashed border-cyan-500/50 flex flex-col items-center justify-center cursor-pointer shadow-2xl transition-all">
                <i class="fas fa-fingerprint text-7xl mb-4 opacity-20"></i>
                <p class="font-bold opacity-50 text-lg">ุงููุฑ ูููุดู ๐</p>
            </div>
            <button id="nextBtn" class="hidden mt-6 w-full dynamic-bg-primary py-5 rounded-2xl font-black uppercase tracking-wider text-lg shadow-xl">ุงูุชุงูู โ๏ธ</button>
        </div>
    </div>

    <!-- Discussion Screen -->
    <div id="discussion-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-4xl rounded-[2rem] p-4 border border-white/10 shadow-2xl relative" style="max-height:94dvh;overflow-y:auto;">
            
            <!-- Chat Button -->
            <button id="toggleChatBtn" class="fixed top-6 left-6 z-[60] bg-gradient-to-r from-cyan-500 to-blue-500 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-all border-2 border-cyan-400/50">
                <i class="fas fa-comments text-2xl"></i>
            </button>

            <!-- Chat Window -->
            <div id="chatWindow" class="hidden fixed top-20 left-6 z-[60] w-80 glass rounded-2xl p-4 border-2 border-cyan-500/30 shadow-2xl animate__animated animate__slideInLeft">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-black text-cyan-400 neon-text">๐ฌ ุงูุดุงุช</h3>
                    <button id="closeChatBtn" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="discussionMessages" class="h-64 overflow-y-auto custom-scrollbar mb-3 text-right text-xs bg-black/40 p-3 rounded-xl border border-white/10"></div>
                <div class="flex gap-2">
                    <input id="discussionInput" type="text" class="flex-1 bg-black/40 border border-white/10 p-2 rounded-lg text-xs outline-none focus:border-cyan-500" placeholder="ุงูุชุจ ุฑุณุงูุชู...">
                    <button id="sendDiscussionBtn" class="dynamic-bg-primary px-4 rounded-lg text-xs font-black">
                        ุฅุฑุณุงู
                    </button>
                </div>
            </div>

            <h2 class="text-2xl font-black mb-6 text-center neon-text">ููุงุด ุงูุฌููุฉ ๐ฃ๏ธ</h2>
            
            <!-- Suspects List -->
            <div id="suspectsList" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6"></div>

            <button id="goVoteBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 py-4 rounded-2xl font-black text-sm shadow-xl hover:scale-102 transition-all uppercase tracking-wider border-2 border-purple-400/50">
                ุงูุงูุชูุงู ููุชุตููุช โ
            </button>
            <p id="discussionInfo" class="text-[10px] opacity-60 mt-2 text-center font-bold">
                ุณูุชู ุงูุงูุชูุงู ููุชุตููุช ุนูุฏูุง ูุถุบุท ุฌููุน ุงููุงุนุจูู ุนูู ุฒุฑ ุงูุงูุชูุงู.
            </p>
                <!-- HINT SYSTEM -->
                <div id="hint-section" class="mt-3 flex items-center justify-between p-3 rounded-xl" style="background:rgba(255,215,0,.08);border:2px solid rgba(255,215,0,.2);">
                    <div class="flex items-center gap-2">
                        <span style="font-size:20px;">๐ก</span>
                        <div>
                            <p class="text-xs font-bold text-yellow-400">ุชูููุญ ููุฃุจุฑูุงุก</p>
                            <p class="text-xs text-gray-400">ุฑุตูุฏู: <span id="hintBalance" class="text-yellow-400 font-bold">0</span> ุชูููุญ</p>
                        </div>
                    </div>
                    <button id="useHintBtn" onclick="useHint()" class="px-4 py-2 rounded-xl font-black text-xs uppercase transition-all"
                        style="background:linear-gradient(135deg,rgba(255,215,0,.3),rgba(255,165,0,.2));border:2px solid rgba(255,215,0,.5);color:#ffd700;">
                        ุงุณุชุฎุฏู ุชูููุญุงู
                    </button>
                </div>
                <div id="hint-display" class="hidden mt-2 p-3 rounded-xl text-center" style="background:rgba(255,215,0,.1);border:2px solid rgba(255,215,0,.3);">
                    <p class="text-xs text-gray-400 mb-1">๐ก ุงูุชูููุญ</p>
                    <p id="hint-text" class="font-black text-yellow-400"></p>
                </div>
        </div>
    </div>

    <!-- Voting Screen -->
    <div id="voting-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-2xl rounded-[2.5rem] p-6 border border-white/10 shadow-2xl relative">
            <h2 class="text-2xl font-black mb-4 text-center neon-text">ุงูุชุตููุช ๐ต๏ธโโ๏ธ</h2>
            <p class="text-sm opacity-70 mb-4 text-center font-bold">ุงุฎุชุฑ ุงููุงุนุจ ุงูุฐู ุชุดู ุฃูู ุงูุฌุงุณูุณ</p>
            
            <div id="voteCards" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6"></div>
            
            <p id="votingStatus" class="text-xs opacity-60 mt-4 text-center font-bold"></p>
        </div>
    </div>

    <!-- Tie Screen -->
    <div id="tie-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/95 backdrop-blur-md animate__animated animate__fadeIn">
        <h1 class="text-8xl font-black text-yellow-500 animate__animated animate__bounceIn" style="text-shadow: 0 0 30px rgba(234, 179, 8, 0.8); font-family: 'Orbitron', sans-serif;">
            ุชุนุงุฏู! ๐ค
        </h1>
    </div>

    <!-- Spinner Screen -->
    <div id="spinner-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-md rounded-[2.5rem] p-6 border border-white/10 shadow-2xl text-center">
            <h2 class="text-2xl font-black mb-4 neon-text">ุงุฎุชูุงุฑ ุนุดูุงุฆู ๐ฏ</h2>
            <p class="text-sm opacity-70 mb-4">ุญุฏุซ ุชุนุงุฏูุ ุณูุชู ุงุฎุชูุงุฑ ูุงุนุจ ุนุดูุงุฆู</p>
            
            <div id="spinnerWheel" class="relative w-64 h-64 mx-auto mb-6 bg-gradient-to-br from-purple-900 to-pink-900 rounded-full border-4 border-yellow-500 flex items-center justify-center shadow-[0_0_50px_rgba(234,179,8,0.5)]">
                <div id="spinnerPointer" class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-4 w-0 h-0 border-l-8 border-r-8 border-t-16 border-transparent border-t-yellow-500 z-10"></div>
                <div id="spinnerContent" class="text-3xl font-black text-white"></div>
            </div>
            
            <button id="startSpinnerBtn" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 py-4 rounded-2xl font-black text-lg shadow-xl hover:scale-105 transition-all border-2 border-yellow-400/50">
                ุงุจุฏุฃ ุงูุณุญุจ ๐ฐ
            </button>
        </div>
    </div>

    <!-- Spy Guess Screen -->
    <div id="spy-guess-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-2xl rounded-[2.5rem] p-6 border border-red-500/30 shadow-2xl text-center max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-black mb-2 text-red-500 neon-text" style="text-shadow: 0 0 15px rgba(239, 68, 68, 0.8);">๐ต๏ธ ุงูุฌุงุณูุณ ุงูููุดูู</h2>
            <p id="spyNameDisplay" class="text-xl mb-4 font-bold"></p>
            <p class="text-sm opacity-70 mb-4">ุงุฎุชุฑ ุงููููุฉ ุงูุตุญูุญุฉ ูู ุงููุงุฆูุฉ</p>
            
            <div id="categoryWordsList" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6 max-h-96 overflow-y-auto custom-scrollbar"></div>
            
            <p id="guessResult" class="text-lg font-black mt-4"></p>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-lg rounded-[2.5rem] p-8 border border-white/10 shadow-2xl text-center">
            <div id="resultIcon" class="text-8xl mb-4"></div>
            <h2 id="resultTitle" class="text-3xl font-black mb-2 neon-text"></h2>
            <p id="resultMessage" class="text-lg mb-6 font-bold"></p>
            <button id="returnToRoomBtn" class="w-full dynamic-bg-primary py-4 rounded-2xl font-black shadow-xl uppercase tracking-wider">
                ุงูุนูุฏุฉ ููุบุฑูุฉ ๐
            </button>
        </div>
    </div>

    <!-- Room Overlay -->
    <div id="room-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-lg rounded-[2.5rem] p-6 border border-white/10 shadow-2xl relative overflow-y-auto" style="max-height:92dvh;">
            
            <!-- Back to Home -->
            <a href="index.html" class="absolute top-4 left-4 text-gray-400 hover:text-cyan-400 transition-colors">
                <i class="fas fa-arrow-right text-xl"></i>
            </a>

            <div class="flex justify-between items-start mb-6 mt-8">
                <div>
                    <h2 class="text-3xl font-black neon-text cursor-pointer" id="roomCodeContainer" title="ุงุถุบุท ูููุณุฎ" style="font-family: 'Orbitron', sans-serif;">
                        <span id="displayRoomCode">----</span> 
                        <i class="fas fa-copy text-sm opacity-30 hover:opacity-100 transition-opacity"></i>
                    </h2>
                    <p class="text-[9px] opacity-50 uppercase font-bold tracking-widest" style="font-family: 'Orbitron', sans-serif;">ููุฏ ุงูุบุฑูุฉ</p>
                </div>
                <button id="leaveRoomBtn" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 text-xs px-4 py-2 rounded-xl font-bold border-2 border-red-500/30 transition-all">
                    ูุบุงุฏุฑุฉ
                </button>
            </div>

            <div id="host-controls" class="hidden space-y-3 mb-6 glass p-4 rounded-2xl border border-white/5">
                <label class="text-[10px] font-bold opacity-40 uppercase tracking-wider" style="font-family: 'Orbitron', sans-serif;">ุฅุนุฏุงุฏุงุช ุงููุถูู</label>
                <select id="updateCat" onchange="updateRoomSettings()" class="w-full bg-black/60 text-sm p-3 rounded-xl border-2 border-cyan-500/20 outline-none focus:border-cyan-500 font-bold">
                    <option value="places">๐ ุฃูุงูู ุณูุงุญูุฉ</option>
                    <option value="food">๐ ุฃููุงุช ูุตุฑูุฉ</option>
                    <option value="jobs">๐๏ธ ููู ููุธุงุฆู</option>
                    <option value="companies">๐ข ุดุฑูุงุช ุนุงูููุฉ</option>
                    <option value="football_teams">โฝ ุฃูุฏูุฉ ูููุชุฎุจุงุช ููุฑุฉ</option>
                </select>
                <div class="flex items-center justify-between bg-black/40 p-3 rounded-xl mb-3 border-2 border-cyan-500/20">
                    <span class="text-xs font-bold">ููุน ุงูุบุฑูุฉ:</span>
                    <button id="toggleVisibility" onclick="toggleRoomVisibility()" class="text-xs px-4 py-1.5 rounded-full border-2 transition-all font-bold"></button>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <label class="text-[11px] font-bold opacity-50 uppercase tracking-widest" style="font-family: 'Orbitron', sans-serif;">ุงููุงุนุจูู ุงููุชุตููู</label>
                    <span id="pCount" class="text-[11px] font-black dynamic-text-primary" style="font-family: 'Orbitron', sans-serif;">0/10</span>
                </div>

                <!-- โ FIX: Players list now has its own fixed-height scroll box.
                     The card/page scrollbar is untouched and still works for scrolling
                     the rest of the room overlay (settings, buttons, etc.). -->
                <div id="roomPlayersList"
                     class="space-y-2 custom-scrollbar"
                     style="max-height: 260px; overflow-y: auto; padding-right: 8px;">
                </div>
            </div>

            <button id="hostStartBtn" class="hidden w-full btn-main py-4 rounded-2xl font-black shadow-xl disabled:opacity-30 disabled:cursor-not-allowed uppercase tracking-wider">
                ุงุจุฏุฃ ุงููุนุจ ๐
            </button>
            <div id="guestWaitMsg" class="hidden text-center py-2 opacity-40 animate-pulse text-sm font-bold">
                ูู ุงูุชุธุงุฑ ุงููุถูู...
            </div>
            <div id="minPlayersMsg" class="hidden text-center text-xs text-yellow-500 mt-2 font-bold">
                ูุฌุจ ุชููุฑ 3 ูุงุนุจูู ุนูู ุงูุฃูู
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update, get, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        
const firebaseConfig = {
  apiKey: "AIzaSyDnd-pmKEatI3DaFz6xHWB5ucurtHXt9tk",
  authDomain: "el-jasus.firebaseapp.com",
  databaseURL: "https://el-jasus-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "el-jasus",
  storageBucket: "el-jasus.firebasestorage.app",
  messagingSenderId: "415659587906",
  appId: "1:415659587906:web:782f7940176ea4097eb0db",
  measurementId: "G-N4K79FP56N"
};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let firebase_auth_user = null;
        let _roomInitialized = false;

        onAuthStateChanged(auth, (user) => {
            firebase_auth_user = user;

            if (window.MOD) {
                MOD.init(db, user ? user.uid : null, ref, update, get);
                MOD.checkOnLoad();
            }

            if (!_roomInitialized) {
                _roomInitialized = true;
                joinPendingAndInit();
            }
        });

        const gameData = {
            places: [
                "ุงููุฏุฑุณุฉ", "ุงููุณุชุดูู", "ุญุฏููุฉ ุงูุญููุงู", "ุงููุทุงุฑ", "ุงููุงุฏู", "ุงูุณูููุง", "ุงููุทุนู", "ุงูุจุญุฑ", "ุงููุฒุฑุนุฉ", "ุงูุณูุฑู",
                "ุงูููุชุจุฉ", "ุงููุณุฌุฏ", "ุงููุญู", "ุงูุตูุฏููุฉ", "ุงูุจูู", "ุงููุญููุฉ", "ุงูุณุฌู", "ุงูุบุงุจุฉ", "ุงูุตุญุฑุงุก",
                "ุงูุฌุจู", "ุงูููุนุฉ", "ุงููุตุฑ", "ุงูููุฏู", "ุงููุชุญู", "ุงููุณุฑุญ", "ุงููุฎุจุฒ", "ุงููููู (ุงููููุฉ)", "ุงูุณูุจุฑ ูุงุฑูุช", "ูุญุทุฉ ุงููุทุงุฑ",
                "ูุญุทุฉ ุงููุชุฑู", "ุงููุฑุดุฉ", "ุงูุงุณุชุงุฏ", "ุงูุฌูู", "ุงูุญุถุงูุฉ", "ุงูุฌุงูุนุฉ", "ุตุงููู ุงูุญูุงูุฉ", "ุงููุนูู", "ุงูููุฒู", "ุงููุทุจุฎ",
                "ุบุฑูุฉ ุงูููู", "ุงูุญูุงู", "ุงูุณุทูุญ", "ุงูุดุงุฑุน", "ุงูููุจุฑู", "ุงููููุงุก", "ุงูุณูุงุฑุฉ", "ุงููุฑุตุฏ", "ุงููุฎูู", "ุงูุดูุงู",
                "ุงูุจุญูุฑุฉ", "ุงูููู", "ุงููุณุจุญ (ุงูุจูุณูู)", "ุงููุตูุน", "ุงูููุชุจ", "ุงูุฃุชูุจูุณ", "ุงูุทูุงุฑุฉ", "ุงููุฑูุจ", "ุงููุถุงุก", "ุงูููุฑ",
                "ุงููุฑูุฎ", "ุงูุณูู", "ุงูููุงูู", "ุญุฏููุฉ ุนุงูุฉ", "ุงูุดูุฉ", "ุงููููุง", "ุงูุฎููุฉ", "ุงูุฌุฑุงุฌ", "ุงููุตูุญุฉ ุงูุญููููุฉ", "ุงูุจุฑูุฏ",
                "ูุณู ุงูุดุฑุทุฉ", "ุงููุทุงูุฆ", "ุงูุฅุณุนุงู", "ุงูุนูุงุฏุฉ", "ุงูููู", "ูุญู ุงูููุจุงููุงุช", "ุงูุณุงูุจุฑ", "ุงุณุชูุฏูู ุชุตููุฑ", "ูุงุนุฉ ุฃูุฑุงุญ", "ุนุฒุงุก",
                "ูุนุฑุถ ุณูุงุฑุงุช", "ูุญู ูุฑุฏ", "ูุญู ูุฏุงูุง", "ูุดู", "ุจูุฒููุฉ", "ูููู ูููุฑูุจุงุตุงุช", "ูุบุณูุฉ ุณูุงุฑุงุช", "ูุญู ุญูููุงุช", "ูุฑู ุนูุด", "ูุญู ุณูู",
                "ูุญู ุฌุฒุงุฑุฉ", "ูุญู ุจูุงูุฉ", "ุตุงูุฉ ุจููููุฌ", "ุชูุณ ุทุงููุฉ", "ููุนุจ ููุฑุฉ", "ุงูุจูุฑุตุฉ", "ุงููุฏุจุญ", "ุงูุฌุฒูุฑุฉ", "ุงูููุงุฑุฉ", "ุงูููุงุจุฑ"
            ],
            football_teams: [
                "ุงูุฃููู ุงููุตุฑู", "ุงูุฒูุงูู", "ุงูุฅุณูุงุนููู", "ุงููุตุฑู ุงูุจูุฑุณุนูุฏู", "ุงูุงุชุญุงุฏ ุงูุณููุฏุฑู", "ุจูุฑุงููุฏุฒ", "ุณููุญุฉ", "ููุฏุฑู ูููุชุดุฑ", "ุงูููุงูููู ุงูุนุฑุจ", "ุบุฒู ุงููุญูุฉ", "ุงูุฌููุฉ", "ุงูุจูู ุงูุฃููู", "ุณูุฑุงูููุง ููููุจุงุชุฑุง", "ุฅูุจู", "ุทูุงุฆุน ุงูุฌูุด", "ุญุฑุณ ุงูุญุฏูุฏ", "ุฃุณูุงู",
                "ุงูููุงู ุงูุณุนูุฏู", "ุงููุตุฑ ุงูุณุนูุฏู", "ุงูุงุชุญุงุฏ ุงูุณุนูุฏู", "ุงูุฃููู ุงูุณุนูุฏู", "ุงูุดุจุงุจ ุงูุณุนูุฏู", "ุงูุนูู ุงูุฅูุงุฑุงุชู", "ุดุจุงุจ ุงูุฃููู", "ุงููุฏุงุฏ ุงููุบุฑุจู", "ุงูุฑุฌุงุก ุงููุบุฑุจู", "ุงูุฌูุด ุงููููู", "ุงูุชุฑุฌู ุงูุชููุณู", "ุงููุฌู ุงูุณุงุญูู", "ุงูุฅูุฑููู ุงูุชููุณู", "ุงูุณุฏ ุงููุทุฑู", "ุงูุฏุญูู", "ุงููููุช ุงููููุชู", "ุงููุงุฏุณูุฉ ุงููููุชู", "ุงููุญุฏุงุช ุงูุฃุฑุฏูู", "ุงูุฒูุฑุงุก ุงูุนุฑุงูู",
                "ูููุฑุจูู", "ูุงูุดุณุชุฑ ุณูุชู", "ูุงูุดุณุชุฑ ูููุงูุชุฏ", "ุฃุฑุณูุงู", "ุชุดููุณู", "ุชูุชููุงู", "ุฃุณุชูู ูููุง", "ููููุงุณู ูููุงูุชุฏ", "ููุณุชุฑ ุณูุชู", "ูุณุช ูุงู",
                "ุฑูุงู ูุฏุฑูุฏ", "ุจุฑุดูููุฉ", "ุฃุชูุชููู ูุฏุฑูุฏ", "ุฅุดุจูููุฉ", "ูุงููุณูุง", "ุฑูุงู ุณูุณูุฏุงุฏ", "ููุงุฑูุงู", "ุจููุจุงู",
                "ููููุชูุณ", "ุฅูู ุณู ูููุงู", "ุฅูุชุฑ ูููุงู", "ูุงุจููู", "ุฑููุง", "ูุงุชุณูู", "ูููุฑูุชููุง", "ุจุงูุฑู ููููุฎ", "ุจูุฑูุณูุง ุฏูุฑุชูููุฏ", "ุจุงูุฑ ูููุฑููุฒู", "ูุงูุจุฒูุฌ", "ุจุงุฑูุณ ุณุงู ุฌูุฑูุงู", "ูุงุฑุณูููุง", "ูููู", "ูููุงูู", "ุฃูุงูุณ ุฃูุณุชุฑุฏุงู", "ุจููููุง", "ุจูุฑุชู",
                "ููุชุฎุจ ูุตุฑ", "ููุชุฎุจ ุงูุณุนูุฏูุฉ", "ููุชุฎุจ ุงููุบุฑุจ", "ููุชุฎุจ ุงูุฌุฒุงุฆุฑ", "ููุชุฎุจ ุชููุณ", "ููุชุฎุจ ูุทุฑ", "ููุชุฎุจ ุงูุจุฑุงุฒูู", "ููุชุฎุจ ุงูุฃุฑุฌูุชูู", "ููุชุฎุจ ูุฑูุณุง", "ููุชุฎุจ ุฃููุงููุง", "ููุชุฎุจ ุฅุณุจุงููุง", "ููุชุฎุจ ุฅูุทุงููุง", "ููุชุฎุจ ุฅูุฌูุชุฑุง", "ููุชุฎุจ ุงูุจุฑุชุบุงู", "ููุชุฎุจ ุจูุฌููุง", "ููุชุฎุจ ูุฑูุงุชูุง", "ููุชุฎุจ ููููุฏุง", "ููุชุฎุจ ุงูุฃูุฑูุบูุงู", "ููุชุฎุจ ุงููุงุจุงู", "ููุชุฎุจ ููุฑูุง ุงูุฌููุจูุฉ", "ููุชุฎุจ ุงูุณูุบุงู", "ููุชุฎุจ ููุฌูุฑูุง", "ููุชุฎุจ ุงููุงููุฑูู"
            ],
            food: [
                "ูุดุฑู", "ูููุฎูุฉ", "ููู", "ุทุนููุฉ (ููุงูู)", "ูุชุฉ ุจุงููุญูุฉ", "ุญูุงูุดู", "ูุญุดู ูุฑูุจ", "ูุญุดู ูุฑู ุนูุจ", "ููุจุงุฑ", "ููุงุฑุน",
                "ูุชุฉ ููุงุฑุน", "ููุชุฉ ูุดููุฉ", "ุทุฑุจ", "ูุจุงุจ", "ูุจุฏุฉ ุฅุณููุฏุฑุงูู", "ุณุฌู ุดุฑูู", "ููุฑููุฉ ุจุดุงููู", "ุฑูุงู ุจุงููุญูุฉ", "ุฌูุงุด", "ุฃุฑุฒ ุจูุจู",
                "ุฃู ุนูู", "ุจุณุจูุณุฉ", "ููุงูุฉ", "ููููุงุช (ูุงุถู)", "ูุทูุฑ ูุดูุชุช", "ูุด ูุฌุจูุฉ ูุฏููุฉ", "ุนุณู ุฃุณูุฏ ูุทุญููุฉ", "ูุดู", "ุจุตุงุฑุฉ", "ุนุฏุณ",
                "ุดูุฑุจุฉ ูุณุงู ุนุตููุฑ", "ุฃุฑุฒ ูุนูุฑ", "ูุณูุนุฉ", "ุชูุฑูู ุฎุถุงุฑ", "ุจุงููุฉ ุจุงููุญูุฉ", "ูููุงุณ", "ุณุจุงูุฎ", "ุฃุฑุฒ ุจุงูุดุนุฑูุฉ", "ูุฑุงุฎ ูุญูุฑุฉ", "ุญูุงู ูุญุดู",
                "ุจุท", "ุฃุฑุงูุจ", "ุณูู ุจูุทู", "ุณูู ุจูุฑู", "ุฌูุจุฑู", "ุณุจูุท", "ูุณูุฎ", "ุฑูุฌุฉ", "ูููุญุฉ", "ุจุทุงุทุณ ูุญูุฑุฉ","ุจุงุจุง ุบููุฌ", "ุณูุทุฉ ุฎุถุฑุงุก", "ูุฎูู (ุทุฑุดู)",
                "ุจุงุฐูุฌุงู ูุฎูู", "ุจูุถ ุจุงูุจุณุทุฑูุฉ", "ุดูุดููุฉ", "ุนุฌุฉ", "ูุฎ ุจุงููู", "ูุจุฏุฉ ูููุงูุต", "ููุชุฉ",
                "ููุชุฉ ุฃุฑุฒ", "ุฃุฑุฒ ุตูุงุฏูุฉ", "ูููุฉ ุจุฑุชูุงู", "ุฑุฒ ุจูุจู", "ูููุจูุฉ", "ููุฑ ุงูุฏูู", "ุนุงุดูุฑุง", "ุฒูุงุจูุง", "ุจูุญ ุงูุดุงู", "ุตูุงุจุน ุฒููุจ",
                "ูุญู ุงูุนูุฏ", "ุจุณูููุช ูุดุงุฏุฑ", "ุบุฑูุจุฉ", "ุจูุชูููุฑ", "ูููู (ูุฑุงููุด)", "ูุฑุต ุจุนุฌูุฉ", "ุนูุด ุจูุฏู", "ุนูุด ูููู", "ุดุงูุฑูุง ูุตุฑู", "ูุฑุงุฎ ุจุงููู",
                "ุตูููุฉ ุจุทุงุทุณ", "ููุฑููุฉ ุจุงูุตูุตุฉ", "ุณุงูุฏูุชุด ุฌุจูุฉ", "ุดุงู ุจูุจู", "ุณุญูุจ", "ุนุตูุฑ ูุตุจ", "ุนุฑูุณูุณ", "ุชูุฑููุฏู", "ุฎุฑูุจ", "ุณูุจูุง",
                "ูุฏูุณ", "ุจูุถ ูุณููู", "ุฌุจูุฉ ุจูุถุง", "ูุงูุดูู", "ุจุณุทุฑูุฉ", "ูุฎุฑูุทุฉ", "ููุณุฉ ุจุงูุจุดุงููู", "ุฃุฑุฒ ุจุงูุฎูุทุฉ", "ูุจุฏุฉ ุฌููู", "ูุฑูู"
            ],
            jobs: [
                "ุฏูุชูุฑ", "ูููุฏุณ", "ูุฏุฑุณ", "ุถุงุจุท", "ูุญุงูู", "ูุญุงุณุจ", "ููุฑุถ", "ุตูุฏูู", "ุทูุงุฑ", "ุณูุงู",
                "ูุฌุงุฑ", "ุณุจุงู", "ููุฑุจุงุฆู", "ููุงุด", "ุจูุง", "ูููุงูููู", "ุญูุงู", "ุฎูุงุท", "ุทุจุงุฎ", "ุฌุฒุงุฑ",
                "ุจุงุฆุน", "ุตุญูู", "ูุฐูุน", "ููุซู", "ูุบูู", "ุฑุณุงู", "ูุตูุฑ", "ูุงุนุจ ููุฑุฉ", "ูุฏุฑุจ", "ุญูู",
                "ุนุงูู ูุธุงูุฉ", "ุจูุงุจ", "ุนุงูู ุฏูููุฑู", "ูุฌุงุฑ ูุณูุญ", "ุญุฏุงุฏ", "ููุงุญ", "ุตูุงุฏ", "ูุงุถู", "ุฑุฌู ุฅุทูุงุก", "ุนุณูุฑู",
                "ูุฃุฐูู", "ุฅูุงู ูุณุฌุฏ", "ูุณูุณ", "ูุฃูู", "ุดุงุนุฑ", "ูุฎุฑุฌ", "ูููุชูุฑ", "ูุตูู ุฌุฑุงููู", "ูุจุฑูุฌ", "ููุฑ",
                "ุนุงูู", "ุฑุงุฆุฏ ูุถุงุก", "ุบุทุงุณ", "ุทูุงุฑ ุญุฑุจู", "ูุถููุฉ ุทูุฑุงู", "ูุชุฑุฌู", "ุณูุฑุชูุฑ", "ูุฏูุฑ", "ูุฒูุฑ", "ุฑุฆูุณ",
                "ุฎุจูุฑ ุชุฌููู", "ููุฏูู", "ููุชููุจุฑ", "ุชููุชููุฑ", "ุจููุฌุฑ", "ุนุงูู ุจูุฒููุฉ", "ุตุฑุงู", "ุฌุฑุณูู", "ุดูู", "ุญููุงูู",
                "ุฎููุฑ", "ุจูุฏู ุฌุงุฑุฏ", "ูุญูู", "ุฌุงุณูุณ", "ุฑุฌู ุฃุนูุงู", "ุจุงุฆุน ุฎุถุงุฑ", "ุจุงุฆุน ูุงููุฉ", "ุจุงุฆุน ูุจู", "ูููุฌู", "ููุฌุฏ",
                "ุนุงูู ุจูุงุก", "ููู ุชูููู", "ููู ุฑุงุฏูู", "ุณุงุญุฑ", "ููุฑุฌ", "ุฑุงูุต", "ูุฏุฑุจ ุฌูู", "ุณุจุงุญ ูุญุชุฑู", "ุนุงูู ููุฌู", "ุนุงูู ุดุญู",
                "ุณุงุนู ุจุฑูุฏ", "ููุธู ุงุณุชูุจุงู", "ุทุจูุจ ุจูุทุฑู", "ุทุจูุจ ุฃุณูุงู", "ุทุจูุจ ุนููู", "ูุญูู ููุฑุฉ", "ุณูุณุงุฑ", "ุชุงุฌุฑ", "ููุงูู", "ุทูุงุฑ ุฏุฑูู"
            ],
            companies: [
                "Apple", "Google", "Microsoft", "Amazon", "Facebook", "Instagram", "WhatsApp", "YouTube", "TikTok", "Netflix",
                "Samsung", "Huawei", "Xiaomi", "Oppo", "Sony", "LG", "Dell", "HP", "Intel", "Canon",
                "Tesla", "Toyota", "Mercedes", "BMW", "Audi", "Ferrari", "Lamborghini", "Ford", "Chevrolet", "Jeep",
                "Nike", "Adidas", "Puma", "Zara", "H&M", "Gucci", "Prada", "Rolex", "Lacoste", "Chanel",
                "McDonald's", "KFC", "Burger King", "Pizza Hut", "Subway", "Starbucks", "Pepsi", "Coca-Cola", "Red Bull", "KitKat",
                "Disney", "Marvel", "DC Comics", "Warner Bros", "Paramount", "Pixar", "Universal", "Spotify", "Snapchat", "Telegram",
                "Visa", "Mastercard", "PayPal", "Binance", "Amazon", "eBay", "Alibaba", "AliExpress", "Shein", "Noon",
                "Uber", "Careem", "Airbnb", "Booking", "FedEx", "DHL", "Aramex", "IKEA", "Walmart", "Carrefour",
                "Nestle", "Dove", "Nivea", "L'Oreal", "Johnson's", "Colgate", "Gillette", "Rolex", "Casio", "Nikon",
                "Lego", "Barbie", "Hot Wheels", "PlayStation", "Xbox", "Nintendo", "Zoom", "Skype", "Slack", "LinkedIn"
            ]
        };

        let myName = localStorage.getItem('eljasus_user_name') || "";
        let myRoom = localStorage.getItem('currentRoom') || "";
        let isHost = localStorage.getItem('isHost') === 'true';

        const pendingRoom = localStorage.getItem('pendingRoomJoin');
        if (pendingRoom) {
            myRoom = pendingRoom;
            localStorage.removeItem('pendingRoomJoin');
            localStorage.setItem('currentRoom', myRoom);
        }

        if (!myRoom || !myName) {
            window.location.href = 'index.html';
        }

        function toArray(val) {
            if (!val) return [];
            if (Array.isArray(val)) return val;
            return Object.values(val);
        }

        async function joinPendingAndInit() {
            if (pendingRoom) {
                try {
                    const snap = await get(ref(db, 'rooms/' + myRoom));
                    if (snap.exists()) {
                        const d = snap.val();
                        const players = toArray(d.players);
                        if (!players.includes(myName)) {
                            if (players.length < 10) {
                                await update(ref(db, 'rooms/' + myRoom), { players: [...players, myName] });
                            }
                        }
                        isHost = false;
                        localStorage.setItem('isHost', 'false');
                    } else {
                        alert('ุงูุบุฑูุฉ ุบูุฑ ููุฌูุฏุฉ');
                        window.location.href = 'index.html';
                        return;
                    }
                } catch(e) {
                    console.error('Failed to join pending room:', e);
                    alert('ูุดู ุงูุงูุถูุงู ููุบุฑูุฉ: ' + e.message);
                    window.location.href = 'index.html';
                    return;
                }
            }
            setupPresence(myRoom, myName);
            initRoom();
        }

        function hideAllGameScreens() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('discussion-screen').classList.add('hidden');
            document.getElementById('voting-screen').classList.add('hidden');
            document.getElementById('tie-screen').classList.add('hidden');
            document.getElementById('spinner-screen').classList.add('hidden');
            document.getElementById('spy-guess-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('room-overlay').classList.add('hidden');
        }

        function setupPresence(roomCode, playerName) {
            const connectedRef = ref(db, ".info/connected");
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    const roomRef = ref(db, `rooms/${roomCode}`);
                    onDisconnect(roomRef).get().then((snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            if (data.host === playerName) {
                                onDisconnect(roomRef).remove();
                            } else {
                                let updatedPlayers = toArray(data.players).map(p => 
                                    p === playerName ? `${playerName} (ุฎุงูู)` : p
                                );
                                onDisconnect(ref(db, `rooms/${roomCode}/players`)).set(updatedPlayers);
                            }
                        }
                    });
                }
            });
        }

        function initRoom() {
            const roomRef = ref(db, 'rooms/' + myRoom);
            
            onValue(roomRef, (snap) => {
                let d;
                try { d = snap.val(); } catch(e) { console.error('Room read error:', e); return; }
                if(!d) { 
                    localStorage.removeItem('currentRoom');
                    localStorage.removeItem('isHost');
                    window.location.href = 'index.html';
                    return; 
                }
                if (d.players && toArray(d.players).includes(`${myName} (ุฎุงูู)`)) {
                    let restoredPlayers = toArray(d.players).map(p => p === `${myName} (ุฎุงูู)` ? myName : p);
                    update(ref(db, 'rooms/' + myRoom), { players: restoredPlayers });
                    return;
                }
                
                if(!toArray(d.players).includes(myName)) {
                    alert("ุชู ุทุฑุฏู ูู ุงูุบุฑูุฉ");
                    localStorage.removeItem('currentRoom');
                    localStorage.removeItem('isHost');
                    window.location.href = 'index.html';
                    return;
                }

                document.getElementById('displayRoomCode').innerText = myRoom;
                const pCount = toArray(d.players).length;
                document.getElementById('pCount').innerText = `${pCount}/10`;
                
                isHost = (d.host === myName);

                if(isHost) {
                    document.getElementById('host-controls').classList.remove('hidden');
                    document.getElementById('hostStartBtn').classList.remove('hidden');
                    document.getElementById('guestWaitMsg').classList.add('hidden');
                    
                    const startBtn = document.getElementById('hostStartBtn');
                    const msg = document.getElementById('minPlayersMsg');
                    if(pCount >= 3) {
                        startBtn.disabled = false;
                        msg.classList.add('hidden');
                    } else {
                        startBtn.disabled = true;
                        msg.classList.remove('hidden');
                    }

                    const vBtn = document.getElementById('toggleVisibility');
                    vBtn.innerHTML = d.visibility === 'public' ? '<i class="fas fa-globe mr-1"></i> ุนุงู' : '<i class="fas fa-lock mr-1"></i> ุฎุงุต';
                    vBtn.className = d.visibility === 'public' ? "text-xs px-4 py-1.5 rounded-full border-2 border-green-500 text-green-400 font-bold hover:bg-green-500/10" : "text-xs px-4 py-1.5 rounded-full border-2 border-red-500 text-red-400 font-bold hover:bg-red-500/10";
                } else {
                    document.getElementById('host-controls').classList.add('hidden');
                    document.getElementById('hostStartBtn').classList.add('hidden');
                    document.getElementById('guestWaitMsg').classList.remove('hidden');
                    document.getElementById('minPlayersMsg').classList.add('hidden');
                }

                document.getElementById('roomPlayersList').innerHTML = toArray(d.players).map(p => {
                    const isMe = (p === myName);
                    const isTargetHost = (p === d.host);
                    const isIdle = p.includes("(ุฎุงูู)");
                    const displayName = p.replace("(ุฎุงูู)", "").trim();

                    return `
                        <div class="flex justify-between items-center p-3 glass rounded-xl border border-cyan-500/20 mb-2 hover:border-cyan-500/40 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">
                                    ${isTargetHost ? '<i class="fas fa-crown"></i>' : (isIdle ? '๐ค' : '๐ค')} 
                                </span>
                                <span class="text-sm ${isIdle ? 'text-gray-500 italic' : 'text-white font-bold'}">
                                    ${displayName} 
                                    ${isIdle ? '<span class="text-[10px] ml-1 opacity-60 text-gray-500">(ุฎุงูู)</span>' : ''}
                                    ${isMe ? '<span class="text-[10px] text-cyan-400 ml-1">(ุฃูุช)</span>' : ''}
                                </span>
                            </div>
                            
                            ${isHost && !isMe ? `
                                <button onclick="kickPlayer('${p}')" 
                                    class="text-[10px] bg-red-600/20 hover:bg-red-600/40 text-red-400 px-3 py-1.5 rounded-lg font-bold shadow-lg border border-red-500/30 transition-all">
                                    ุทุฑุฏ
                                </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
                if(d.status && d.status !== 'waiting') {
                    hideAllGameScreens();
                    if(d.status === 'playing') showOnlineGame(d);
                    else if(d.status === 'discussion') showDiscussionScreen(d);
                    else if(d.status === 'voting') showVotingScreen(d);
                    else if(d.status === 'tie') showTieScreen(d);
                    else if(d.status === 'spinner') showSpinnerScreen(d);
                    else if(d.status === 'spy_guess') showSpyGuessScreen(d);
                    else if(d.status === 'result') showResultScreen(d);
                } else { 
                    hideAllGameScreens();
                    document.getElementById('room-overlay').classList.remove('hidden');
                }
            });
        }

        async function handleLeave(data, nameToLeave) {
            let players = toArray(data.players).filter(p => p !== nameToLeave);
            if(players.length === 0) {
                await remove(ref(db, 'rooms/' + myRoom));
            } else {
                let updates = { players: players };
                if(data.host === nameToLeave) {
                    updates.host = players[Math.floor(Math.random() * players.length)];
                }
                await update(ref(db, 'rooms/' + myRoom), updates);
            }
        }

        window.kickPlayer = async (targetName) => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            if(snap.exists()) {
                const d = snap.val();
                const newPlayers = toArray(d.players).filter(p => p !== targetName);
                await update(ref(db, 'rooms/' + myRoom), { players: newPlayers });
            }
        };

        document.getElementById('leaveRoomBtn').onclick = async () => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            if(snap.exists()) {
                await handleLeave(snap.val(), myName);
            }
            localStorage.removeItem('currentRoom');
            localStorage.removeItem('isHost');
            window.location.href = 'index.html';
        };

        window.toggleRoomVisibility = async () => {
            const s = await get(ref(db, 'rooms/' + myRoom));
            update(ref(db, 'rooms/' + myRoom), { visibility: s.val().visibility === 'private' ? 'public' : 'private' });
        };

        window.updateRoomSettings = () => {
            update(ref(db, 'rooms/' + myRoom), { category: document.getElementById('updateCat').value });
        };

        document.getElementById('hostStartBtn').onclick = async () => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d = snap.val();
            
            if(d.status && d.status !== 'waiting') {
                alert("ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ ุญุชู ุงูุชูุงุก ุงูุฌููุฉ ุงูุญุงููุฉ");
                return;
            }
            
            const secret = gameData[d.category][Math.floor(Math.random() * gameData[d.category].length)];
            const spyCount = toArray(d.players).length >= 12 ? 3 : toArray(d.players).length >= 8 ? 2 : 1;
            const spyIndices = [];
            while (spyIndices.length < spyCount) {
                const idx = Math.floor(Math.random() * toArray(d.players).length);
                if (!spyIndices.includes(idx)) spyIndices.push(idx);
            }
            update(ref(db, 'rooms/' + myRoom), { 
                status: 'playing', 
                secret: secret, 
                spyIdx: spyIndices[0],
                spyIndices: spyIndices,
                spyCount: spyCount,
                turn: 0,
                suspects: {},
                discussionMessages: [],
                readyForVote: [],
                votes: {},
                tiedPlayers: null,
                spyGuess: null,
                winner: null,
                votedPlayer: null,
                hints: {}
            });
        };

        function showOnlineGame(d) {
            hideAllGameScreens();
            document.getElementById('game-screen').classList.remove('hidden');
            const isMyTurn = d.players[d.turn] === myName;
            document.getElementById('targetPlayer').innerText = d.players[d.turn];
            
            const card = document.getElementById('secretCard');
            const btn = document.getElementById('nextBtn');
            card.classList.remove('reveal-spy', 'reveal-innocent');
            card.innerHTML = `<i class="fas fa-fingerprint text-7xl mb-4 opacity-20"></i><p class="font-bold opacity-50 text-lg">ุงููุฑ ูููุดู ๐</p>`;
            card.style.pointerEvents = isMyTurn ? "auto" : "none";
            btn.classList.add('hidden');

            card.onclick = () => {
                if((d.spyIndices || [d.spyIdx]).includes(toArray(d.players).indexOf(myName))) {
                    card.classList.add('reveal-spy');
                    card.innerHTML = `<i class="fas fa-user-secret text-8xl mb-4"></i><h2 class="text-4xl font-black italic">ุฌุงุณูุณ</h2>`;
                    if(window.SND) SND.announce.spyReveal();
                    if(window.particleSystem) particleSystem.spyReveal();
                } else {
                    card.classList.add('reveal-innocent');
                    card.innerHTML = `<i class="fas fa-key text-6xl mb-4"></i><h2 class="text-4xl font-black">${d.secret}</h2>`;
                    if(window.SND) SND.announce.innocentReveal();
                    if(window.particleSystem) particleSystem.innocentReveal();
                }
                btn.classList.remove('hidden');
                card.onclick = null;
            };

            btn.onclick = () => {
                if(d.turn + 1 >= toArray(d.players).length) {
                    update(ref(db, 'rooms/' + myRoom), { 
                        status: 'discussion',
                        suspects: {},
                        discussionMessages: [],
                        readyForVote: [],
                        votes: {}
                    });
                } else {
                    update(ref(db, 'rooms/' + myRoom), { turn: d.turn + 1 });
                }
            };
        }

        function showDiscussionScreen(d) {
            hideAllGameScreens();
            document.getElementById('discussion-screen').classList.remove('hidden');

            const chatInput = document.getElementById('discussionInput');
            if (chatInput && window.EmojiPicker && !chatInput._emojiInit) {
                chatInput._emojiInit = true;
                new EmojiPicker(chatInput, null);
            }

            if (typeof loadHintBalance === 'function') loadHintBalance();
            showRoomHints(d);
            
            suspectsList.innerHTML = toArray(d.players).map(p => {
                const suspectCount = d.suspects && d.suspects[p] ? d.suspects[p].length : 0;
                const isSuspect = d.suspects && d.suspects[p] && d.suspects[p].includes(myName);
                return `
                    <div class="glass rounded-2xl p-4 border-2 ${isSuspect ? 'border-red-500' : 'border-cyan-500/30'} text-center hover:border-cyan-500/60 transition-all">
                        <div class="text-3xl mb-2">${p === d.host ? '๐' : '๐ค'}</div>
                        <h3 class="font-black text-sm mb-2">${p}</h3>
                        <div class="text-xs opacity-60 mb-3">${suspectCount} ุดุฎุต ูุดู ุจู</div>
                        <button onclick="toggleSuspect('${p}')" class="${isSuspect ? 'bg-red-600 hover:bg-red-700' : 'bg-white/10 hover:bg-white/20'} w-full py-2 rounded-lg text-xs font-bold transition-all border-2 ${isSuspect ? 'border-red-400' : 'border-white/20'}">
                            ${isSuspect ? 'ุฅูุบุงุก ุงูุดู โ' : 'ุฃุดู ุจู ๐'}
                        </button>
                    </div>
                `;
            }).join('');

            if(d.discussionMessages) {
                const messagesDiv = document.getElementById('discussionMessages');
                messagesDiv.innerHTML = d.discussionMessages.map(m => 
                    `<div class="mb-2"><span class="font-bold text-cyan-400">${m.player}:</span> ${m.msg}</div>`
                ).join('');
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            const readyCount = d.readyForVote ? d.readyForVote.length : 0;
            document.getElementById('discussionInfo').innerText = `${readyCount}/${toArray(d.players).length} ูุงุนุจ ุฌุงูุฒ ููุชุตููุช`;
            
            const goVoteBtn = document.getElementById('goVoteBtn');
            const isReady = d.readyForVote && d.readyForVote.includes(myName);
            goVoteBtn.innerText = isReady ? 'ูู ุงูุชุธุงุฑ ุงููุงุนุจูู... โณ' : 'ุงูุงูุชูุงู ููุชุตููุช โ';
            goVoteBtn.disabled = isReady;
            goVoteBtn.onclick = () => markReadyForVote();
        }

        window.toggleSuspect = async (targetPlayer) => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d = snap.val();
            let suspects = d.suspects || {};
            if(!suspects[targetPlayer]) suspects[targetPlayer] = [];
            if(suspects[targetPlayer].includes(myName)) {
                suspects[targetPlayer] = suspects[targetPlayer].filter(p => p !== myName);
            } else {
                suspects[targetPlayer].push(myName);
            }
            update(ref(db, 'rooms/' + myRoom), { suspects });
        };

        async function markReadyForVote() {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d = snap.val();
            let ready = d.readyForVote || [];
            if(!ready.includes(myName)) {
                ready.push(myName);
                await update(ref(db, 'rooms/' + myRoom), { readyForVote: ready });
            }
            if(ready.length >= toArray(d.players).length) {
                await update(ref(db, 'rooms/' + myRoom), { status: 'voting', votes: {} });
            }
        }

        document.getElementById('toggleChatBtn').onclick = () => {
            document.getElementById('chatWindow').classList.toggle('hidden');
        };

        document.getElementById('closeChatBtn').onclick = () => {
            document.getElementById('chatWindow').classList.add('hidden');
        };

        document.getElementById('sendDiscussionBtn').onclick = async () => {
            const input = document.getElementById('discussionInput');
            const msg = input.value.trim();
            if(!msg) return;

            if (window.MOD && await MOD.checkAndHandleMessage(msg, myName)) {
                input.value = '';
                return;
            }
            
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d = snap.val();
            let messages = d.discussionMessages || [];
            messages.push({ player: myName, msg: msg });
            await update(ref(db, 'rooms/' + myRoom), { discussionMessages: messages });
            input.value = '';
        };

        document.getElementById('discussionInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('sendDiscussionBtn').click();
        });

        function showVotingScreen(d) {
            if (window.SND) SND.announce.voting();
            hideAllGameScreens();
            document.getElementById('voting-screen').classList.remove('hidden');
            
            const hasVoted = d.votes && d.votes[myName];
            const voteCards = document.getElementById('voteCards');
            
            voteCards.innerHTML = toArray(d.players).map(p => {
                const voteCount = Object.values(d.votes || {}).filter(v => v === p).length;
                const isMyVote = d.votes && d.votes[myName] === p;
                return `
                    <div class="glass rounded-2xl p-4 border-2 ${isMyVote ? 'border-yellow-500' : 'border-cyan-500/30'} text-center ${hasVoted ? 'opacity-50' : ''} hover:border-cyan-500/60 transition-all">
                        <div class="text-4xl mb-2">${p === d.host ? '๐' : '๐ค'}</div>
                        <h3 class="font-black text-sm mb-2">${p}</h3>
                        <div class="text-xs opacity-60 mb-3 font-bold">${voteCount} ุตูุช</div>
                        <button onclick="castVote('${p}')" ${hasVoted ? 'disabled' : ''} class="bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 disabled:cursor-not-allowed w-full py-2 rounded-lg text-xs font-bold transition-all border-2 border-yellow-400/50">
                            ${isMyVote ? 'ุชู ุงูุชุตููุช โ' : 'ุตููุช ๐ณ๏ธ'}
                        </button>
                    </div>
                `;
            }).join('');

            const votedCount = Object.keys(d.votes || {}).length;
            document.getElementById('votingStatus').innerText = `${votedCount}/${toArray(d.players).length} ูุงุนุจ ูุงู ุจุงูุชุตููุช`;
        }

        window.castVote = async (targetPlayer) => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d = snap.val();
            if(d.votes && d.votes[myName]) return;
            let votes = d.votes || {};
            votes[myName] = targetPlayer;
            await update(ref(db, 'rooms/' + myRoom), { votes });
            if(Object.keys(votes).length >= toArray(d.players).length) {
                processVotes(d, votes);
            }
        };

        async function processVotes(d, votes) {
            const voteCounts = {};
            toArray(d.players).forEach(p => voteCounts[p] = 0);
            Object.values(votes).forEach(v => voteCounts[v]++);
            const maxVotes = Math.max(...Object.values(voteCounts));
            const topVoted = Object.keys(voteCounts).filter(p => voteCounts[p] === maxVotes);
            if(topVoted.length > 1) {
                await update(ref(db, 'rooms/' + myRoom), { status: 'tie', tiedPlayers: topVoted });
                setTimeout(async () => {
                    await update(ref(db, 'rooms/' + myRoom), { status: 'spinner' });
                }, 2000);
            } else {
                checkGameResult(d, topVoted[0]);
            }
        }

        function showTieScreen(d) {
            hideAllGameScreens();
            document.getElementById('tie-screen').classList.remove('hidden');
            setTimeout(() => { document.getElementById('tie-screen').classList.add('hidden'); }, 2000);
        }

        function showSpinnerScreen(d) {
            hideAllGameScreens();
            document.getElementById('spinner-screen').classList.remove('hidden');
            const spinnerContent = document.getElementById('spinnerContent');
            const startBtn = document.getElementById('startSpinnerBtn');
            startBtn.onclick = async () => {
                startBtn.disabled = true;
                let index = 0;
                const interval = setInterval(() => {
                    spinnerContent.innerText = d.tiedPlayers[index % d.tiedPlayers.length];
                    index++;
                }, 100);
                setTimeout(async () => {
                    clearInterval(interval);
                    const selected = d.tiedPlayers[Math.floor(Math.random() * d.tiedPlayers.length)];
                    spinnerContent.innerText = selected;
                    setTimeout(async () => { await checkGameResult(d, selected); }, 1500);
                }, 3000);
            };
        }

        async function checkGameResult(d, votedPlayer) {
            const spyName = d.players[d.spyIdx];
            if(votedPlayer === spyName) {
                await update(ref(db, 'rooms/' + myRoom), { status: 'spy_guess', votedPlayer: spyName });
            } else {
                await update(ref(db, 'rooms/' + myRoom), { status: 'result', winner: 'spy', spyName: spyName });
            }
        }

        function showSpyGuessScreen(d) {
            hideAllGameScreens();
            document.getElementById('spy-guess-screen').classList.remove('hidden');
            const spyIndices = d.spyIndices || [d.spyIdx];
            const spyNames   = spyIndices.map(i => d.players[i]).filter(Boolean);
            const spyName    = spyNames[0] || d.players[d.spyIdx];
            document.getElementById('spyNameDisplay').innerText = spyNames.length > 1 
                    ? `ุงูุฌูุงุณูุณ ูู: ${spyNames.join(' ู ')}` 
                    : `ุงูุฌุงุณูุณ ูู: ${spyName}`;
            const categoryWords = gameData[d.category];
            const wordsList = document.getElementById('categoryWordsList');
            const isSpy = spyNames.includes(myName);
            const hasGuessed = d.spyGuess !== undefined;
            wordsList.innerHTML = categoryWords.map(word => `
                <button onclick="spyGuessWord('${word}')" ${!isSpy || hasGuessed ? 'disabled' : ''} 
                    class="glass rounded-xl p-3 border-2 border-cyan-500/30 font-bold text-sm hover:border-cyan-500 disabled:opacity-30 transition-all">
                    ${word}
                </button>
            `).join('');
            if(hasGuessed) {
                const correct = d.spyGuess === d.secret;
                document.getElementById('guessResult').innerHTML = correct ? 
                    '<span class="text-green-500">โ ุฅุฌุงุจุฉ ุตุญูุญุฉ!</span>' : 
                    '<span class="text-red-500">โ ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ!</span>';
            }
        }

        window.spyGuessWord = async (word) => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d = snap.val();
            const correct = word === d.secret;
            await update(ref(db, 'rooms/' + myRoom), { 
                spyGuess: word, status: 'result',
                winner: correct ? 'spy' : 'innocents',
                spyName: d.players[d.spyIdx]
            });
        };

        function showResultScreen(d) {
            setTimeout(() => {
                if (window.SND) {
                    d.winner === 'spy' ? SND.announce.spyWins() : SND.announce.innocentsWin();
                }
                if (window.particleSystem) particleSystem.victoryConfetti();
                setTimeout(() => {
                    if (window.SS) {
                        const myIdx    = toArray(d.players).indexOf(myName);
                        const spyIdxs  = d.spyIndices || [d.spyIdx];
                        const spyNames = spyIdxs.map(i => d.players[i]);
                        SS.capture({
                            winner: d.winner, word: d.secret, category: d.category,
                            players: toArray(d.players).map((name, i) => ({ name, role: spyIdxs.includes(i) ? 'spy' : 'innocent' })),
                            myName, myRole: spyIdxs.includes(myIdx) ? 'spy' : 'innocent',
                            myWon: (d.winner === 'spy' && spyIdxs.includes(myIdx)) || (d.winner === 'innocents' && !spyIdxs.includes(myIdx))
                        });
                    }
                }, 2000);
            }, 500);

            hideAllGameScreens();
            document.getElementById('result-screen').classList.remove('hidden');
            
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');
            
            updatePlayerStats(d);
            
            if(d.winner === 'spy') {
                icon.innerText = '๐ต๏ธ';
                title.innerText = 'ุงูุฌุงุณูุณ ุงูุชุตุฑ!';
                message.innerText = `${d.spyName} ูุฌุญ ูู ุงููููุฉ!`;
            } else {
                icon.innerText = '๐';
                title.innerText = 'ุงูุฃุจุฑูุงุก ุงูุชุตุฑูุง!';
                message.innerText = `ุชู ูุดู ุงูุฌุงุณูุณ ${d.spyName}!`;
            }
            
            document.getElementById('returnToRoomBtn').onclick = async () => {
                hideAllGameScreens();
                await update(ref(db, 'rooms/' + myRoom), { 
                    status: 'waiting', turn: 0, secret: null, spyIdx: null,
                    suspects: {}, discussionMessages: [], readyForVote: [], votes: {},
                    tiedPlayers: null, spyGuess: null, winner: null, votedPlayer: null
                });
                document.getElementById('room-overlay').classList.remove('hidden');
            };
        }

        const RANKS = [
            { name:'Bronze',   min:0,     max:999,      css:'rank-bronze'   },
            { name:'Silver',   min:1000,  max:2499,     css:'rank-silver'   },
            { name:'Gold',     min:2500,  max:4999,     css:'rank-gold'     },
            { name:'Platinum', min:5000,  max:9999,     css:'rank-platinum' },
            { name:'Diamond',  min:10000, max:Infinity, css:'rank-diamond'  }
        ];
        function getRank(pts) { return RANKS.find(r => pts >= r.min && pts <= r.max) || RANKS[0]; }

        const ACHIEVEMENTS = {
            firstWin:       { name:'ุงูููุฒ ุงูุฃูู',   check: s => (s.spyWins+s.innocentWins) >= 1 },
            masterDeceiver: { name:'ุฎุจูุฑ ุงูุฎุฏุงุน',    check: s => s.spyWins >= 10                 },
            eagleEye:       { name:'ุนูู ุงูุตูุฑ',      check: s => (s.correctVotes||0) >= 5         },
            centuryClub:    { name:'ูุงุฏู ุงููุฆุฉ',     check: s => s.totalGames >= 100             },
            hotStreak:      { name:'ุณูุณูุฉ ูุงุฑูุฉ',    check: s => (s.currentStreak||0) >= 5       },
            diamondPlayer:  { name:'ูุงุนุจ ุฃููุงุณู',   check: (s,pts) => pts >= 10000              }
        };

        async function updatePlayerStats(gameData) {
            const winner     = gameData.winner;
            const spyIndices = gameData.spyIndices || [gameData.spyIdx];
            const category   = gameData.category || 'ุนุงู';
            if (!firebase_auth_user) return;
            const uid = firebase_auth_user.uid;
            const myIdx = gameData.players.indexOf(myName);
            if (myIdx === -1) return;
            const isSpy = spyIndices.includes(myIdx);
            const won   = (isSpy && winner === 'spy') || (!isSpy && winner === 'innocents');
            const snap = await get(ref(db, `players/${uid}`));
            const data = snap.exists() ? snap.val() : {};
            const s    = data.stats || {};
            const currentPts = data.rankPoints || 0;
            const newStats = {
                totalGames:       (s.totalGames       || 0) + 1,
                spyWins:          (s.spyWins          || 0) + (isSpy && won ? 1 : 0),
                innocentWins:     (s.innocentWins     || 0) + (!isSpy && won ? 1 : 0),
                spyGames:         (s.spyGames         || 0) + (isSpy ? 1 : 0),
                timesCaughtAsSpy: (s.timesCaughtAsSpy || 0) + (isSpy && !won ? 1 : 0),
                currentStreak:    won ? (s.currentStreak || 0) + 1 : 0,
                longestWinStreak: Math.max(s.longestWinStreak || 0, won ? (s.currentStreak || 0) + 1 : 0),
                lastPlayed:       Date.now()
            };
            let coinsEarned = 5;
            if (won)           coinsEarned += isSpy ? 50 : 20;
            if (newStats.currentStreak >= 3) coinsEarned += newStats.currentStreak * 5;
            const newCoins = (data.coins || 0) + coinsEarned;
            let ptsEarned = 10;
            if (won) ptsEarned += isSpy ? 100 : 50;
            if (newStats.currentStreak > 1) ptsEarned += newStats.currentStreak * 10;
            const newPts  = currentPts + ptsEarned;
            const newRank = getRank(newPts);
            const oldRank = getRank(currentPts);
            const catStats = data.categoryStats || {};
            catStats[category] = (catStats[category] || 0) + 1;
            const history = data.gameHistory || [];
            history.push({ role: isSpy?'spy':'innocent', won, category, timestamp: Date.now() });
            if (history.length > 50) history.splice(0, history.length - 50);
            const unlocked = data.achievements || {};
            const newlyUnlocked = [];
            for (const [id, ach] of Object.entries(ACHIEVEMENTS)) {
                if (!unlocked[id] && ach.check(newStats, newPts)) {
                    unlocked[id] = { timestamp: Date.now() };
                    newlyUnlocked.push(ach.name);
                    coinsEarned += 100;
                }
            }
            const updates = {};
            updates[`players/${uid}/stats`]        = newStats;
            updates[`players/${uid}/coins`]        = newCoins;
            updates[`players/${uid}/rankPoints`]   = newPts;
            updates[`players/${uid}/rank`]         = newRank.name;
            updates[`players/${uid}/categoryStats`]= catStats;
            updates[`players/${uid}/gameHistory`]  = history;
            updates[`players/${uid}/achievements`] = unlocked;
            await update(ref(db), updates);
            setTimeout(() => {
                if (window.SND) SND.announce.coinsEarned(coinsEarned);
                if (window.showToast) showToast('๐ช +' + coinsEarned + ' ุนููุฉ  โข  +' + ptsEarned + ' ููุทุฉ ุฑุชุจุฉ');
                if (newRank.name !== oldRank.name) {
                    if (window.SND) SND.announce.rankUp(newRank.name);
                    if (window.particleSystem) particleSystem.burst(40, 'particle-victory');
                    setTimeout(() => showToast('๐ ุชุฑููุฉ! ุฃุตุจุญุช ' + newRank.name), 2000);
                }
                newlyUnlocked.forEach((name, i) => {
                    setTimeout(() => {
                        if (window.SND) SND.announce.achievement(name);
                        if (window.showToast) showToast('๐ ุฅูุฌุงุฒ ุฌุฏูุฏ: ' + name);
                    }, (i + 1) * 3000);
                });
            }, 1500);
        }

        document.getElementById('roomCodeContainer').onclick = () => {
            navigator.clipboard.writeText(myRoom)
                .then(() => { if(window.showToast) showToast('๐ ุชู ูุณุฎ ุงูููุฏ: ' + myRoom); })
                .catch(() => {});
        };

        const qrShareEl = document.getElementById('roomCodeContainer');
        if (qrShareEl) {
            const qrBtn = document.createElement('button');
            qrBtn.innerHTML = '๐ฒ';
            qrBtn.title = 'ูุดุงุฑูุฉ QR';
            qrBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:18px;margin-right:6px;';
            qrBtn.onclick = (e) => { e.stopPropagation(); if(window.QR) QR.generate(myRoom); };
            qrShareEl.appendChild(qrBtn);
        }

        setTimeout(() => {
            if (window.VoiceChat && firebase_auth_user) {
                window._firebaseFns = { ref, push, onChildAdded };
                window.VC = new VoiceChat(db, myRoom, firebase_auth_user.uid, myName);
            }
        }, 2000);

        async function loadHintBalance() {
            if (!firebase_auth_user) return;
            const snap = await get(ref(db, `players/${firebase_auth_user.uid}/hints`));
            document.getElementById('hintBalance').innerText = snap.val() || 0;
        }

        window.useHint = async function() {
            if (!firebase_auth_user) { alert('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู'); return; }
            const snap = await get(ref(db, `players/${firebase_auth_user.uid}/hints`));
            const bal  = snap.val() || 0;
            if (bal < 1) { alert('ููุณ ูุฏูู ุชูููุญุงุช! ุงุดุชุฑู ุงููุฒูุฏ ูู ุงููุชุฌุฑ.'); return; }
            const roomSnap = await get(ref(db, 'rooms/' + myRoom));
            const d = roomSnap.val();
            if (!d) return;
            const spyIndices = d.spyIndices || [d.spyIdx];
            const spyNames   = spyIndices.map(i => d.players[i]);
            const innocents  = toArray(d.players).filter((_, i) => !spyIndices.includes(i));
            const hintTypes = [
                () => `ุงูุฌุงุณูุณ${spyNames.length > 1 ? 'ูู' : ''} ${spyNames.length > 1 ? 'ูู' : 'ูู'} ูุงุฆูุฉ ุงููุงุนุจูู`,
                () => `ููุณ ${innocents[Math.floor(Math.random() * innocents.length)]} ุฌุงุณูุณุงู`,
                () => `ุนุฏุฏ ุงูุฌูุงุณูุณ: ${spyNames.length}`,
                () => `ุงูุฌุงุณูุณ ููุณ ุงููุงุนุจ ุฑูู ${(innocents.indexOf(innocents[Math.floor(Math.random()*innocents.length)])) + 1 } ูู ุงููุงุฆูุฉ`,
                () => `ุงููููุฉ ุงูุณุฑูุฉ ุชุจุฏุฃ ุจุญุฑู "${d.secret ? d.secret[0] : '?'}"`,
            ];
            const hint = hintTypes[Math.floor(Math.random() * hintTypes.length)]();
            await update(ref(db, `players/${firebase_auth_user.uid}`), { hints: bal - 1 });
            document.getElementById('hintBalance').innerText = bal - 1;
            document.getElementById('hint-display').classList.remove('hidden');
            document.getElementById('hint-text').innerText = hint;
            await update(ref(db, 'rooms/' + myRoom), {
                [`hints/${firebase_auth_user.uid}`]: { hint, usedAt: Date.now(), by: myName }
            });
            if (window.SND) SND.play('coins');
        };

        function showRoomHints(d) {
            if (!d.hints) return;
            const vals = Object.values(d.hints);
            if (!vals.length) return;
            const last = vals[vals.length - 1];
            document.getElementById('hint-display').classList.remove('hidden');
            document.getElementById('hint-text').innerText = last.hint + ' (ูู ' + (last.by||'ูุงุนุจ') + ')';
        }
    </script>
    <script src="dialogs.js"></script>
<script>
    window.alert   = (msg)             => UIAlert(msg);
    window.confirm = (msg)             => UIConfirm(msg);
    window.prompt  = (msg, defaultVal) => UIPrompt(msg, { defaultValue: defaultVal });
</script>
</body>
</html>