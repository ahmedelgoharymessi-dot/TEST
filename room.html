<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØºØ±ÙØ© | El Jasus</title>
    <!-- EL JASUS NEW FEATURES -->
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile.css">
    <script src="particles.js" defer></script>
    <script src="sound-system.js" defer></script>
    <script src="qr-notifications.js" defer></script>
    <script src="emoji-reactions.js" defer></script>
    <script src="voice-chat.js" defer></script>
    <script src="screenshot.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="ElJasus2.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="dialogs.js"></script>
    <script src="moderation.js"></script><!-- loaded ONCE here, not again below -->

    <style>
        :root { 
            --bg-color: #0a0e1a;
            --card-color: rgba(15, 20, 35, 0.95);
            --btn-color: #00f2ff;
            --text-color: #ffffff;
            --accent-color: #00f2ff;
            --secondary-color: #7c30ff;
        }
        body { 
            font-family: 'Cairo', sans-serif; 
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1535 50%, #0f0c1d 100%);
            background-attachment: fixed;
            color: var(--text-color); 
            min-height: 100vh; 
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        @keyframes gridMove {
            0% { transform: translateY(0); }
            100% { transform: translateY(50px); }
        }
        .glass { 
            background: linear-gradient(135deg, rgba(15, 20, 35, 0.9), rgba(25, 30, 50, 0.8));
            backdrop-filter: blur(20px);
            border: 2px solid;
            border-image: linear-gradient(135deg, rgba(0, 242, 255, 0.3), rgba(124, 48, 255, 0.3)) 1;
            box-shadow: 0 8px 32px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.1), 0 0 30px rgba(0,242,255,.1);
            position: relative;
            overflow: hidden;
        }
        .glass::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(0,242,255,.05), transparent);
            animation: shimmer 3s infinite;
            pointer-events: none;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        .dynamic-text-primary { color: var(--accent-color); text-shadow: 0 0 10px rgba(0,242,255,.5); font-family: 'Orbitron', sans-serif; }
        .dynamic-bg-primary { background: linear-gradient(135deg, var(--btn-color), var(--secondary-color)); color: #fff; box-shadow: 0 4px 15px rgba(0,242,255,.4), inset 0 -2px 10px rgba(0,0,0,.3); }
        .btn-main { background: linear-gradient(135deg, var(--btn-color), var(--secondary-color)); color: #fff; font-weight: 900; border: 2px solid rgba(0,242,255,.5); box-shadow: 0 0 20px rgba(0,242,255,.4), inset 0 1px 0 rgba(255,255,255,.2); transition: all .3s ease; }
        .btn-main:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 0 30px rgba(0,242,255,.6), 0 8px 20px rgba(0,242,255,.3); }
        .reveal-innocent { background: linear-gradient(145deg, #065f46, #059669) !important; border-color: #34d399 !important; box-shadow: 0 0 40px rgba(52,211,153,.5); animation: flipInY 0.6s; }
        .reveal-spy { background: linear-gradient(145deg, #7f1d1d, #dc2626) !important; border-color: #f87171 !important; box-shadow: 0 0 40px rgba(248,113,113,.5); animation: shakeX 0.5s; }
        .custom-scrollbar::-webkit-scrollbar { width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,242,255,.05); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent-color), var(--secondary-color)); border-radius: 10px; }
        .custom-scrollbar { scrollbar-width: thin; scrollbar-color: var(--accent-color) rgba(0,242,255,.05); }
        .fa-crown { color: #ffd700; filter: drop-shadow(0 0 8px rgba(255,215,0,.8)); }
        .neon-text { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 10px rgba(0,242,255,.8), 0 0 20px rgba(0,242,255,.6); }

        /* â”€â”€ Name Tag / Theme chip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .player-nametag {
            display: inline-block;
            font-size: 9px;
            font-weight: 900;
            letter-spacing: .04em;
            padding: 2px 7px;
            border-radius: 5px;
            background: rgba(0,242,255,.1);
            border: 1px solid rgba(0,242,255,.25);
            color: #00f2ff;
            margin-left: 4px;
            vertical-align: middle;
            flex-shrink: 0;
        }
        .player-rank-badge {
            font-size: 14px;
            line-height: 1;
            flex-shrink: 0;
        }

        /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes _toast_in { from{opacity:0;transform:translateX(-50%) translateY(10px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
    </style>
</head>
<body class="p-4">

    <!-- Game Screen (Turn-based reveal) -->
    <div id="game-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
        <div class="max-w-md w-full">
            <div class="text-center mb-6">
                <p class="text-[11px] dynamic-text-primary font-black uppercase tracking-widest mb-2" style="font-family:'Orbitron',sans-serif;">Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨</p>
                <div id="targetPlayerWrap" class="flex items-center justify-center gap-2 flex-wrap">
                    <h3 id="targetPlayer" class="text-4xl font-black neon-text">---</h3>
                </div>
            </div>
            <div id="secretCard" class="h-96 glass rounded-[2.5rem] border-2 border-dashed border-cyan-500/50 flex flex-col items-center justify-center cursor-pointer shadow-2xl transition-all">
                <i class="fas fa-fingerprint text-7xl mb-4 opacity-20"></i>
                <p class="font-bold opacity-50 text-lg">Ø§Ù†Ù‚Ø± Ù„Ù„ÙƒØ´Ù ğŸ”’</p>
            </div>
            <button id="nextBtn" class="hidden mt-6 w-full dynamic-bg-primary py-5 rounded-2xl font-black uppercase tracking-wider text-lg shadow-xl">Ø§Ù„ØªØ§Ù„ÙŠ âœ”ï¸</button>
        </div>
    </div>

    <!-- Discussion Screen -->
    <div id="discussion-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-4xl rounded-[2rem] p-4 border border-white/10 shadow-2xl relative" style="max-height:94dvh;overflow-y:auto;">
            
            <!-- Chat Button -->
            <button id="toggleChatBtn" class="fixed top-6 left-6 z-[60] bg-gradient-to-r from-cyan-500 to-blue-500 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-all border-2 border-cyan-400/50">
                <i class="fas fa-comments text-2xl"></i>
            </button>

            <!-- Chat Window -->
            <div id="chatWindow" class="hidden fixed top-20 left-6 z-[60] w-80 glass rounded-2xl p-4 border-2 border-cyan-500/30 shadow-2xl animate__animated animate__slideInLeft">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-black text-cyan-400 neon-text">ğŸ’¬ Ø§Ù„Ø´Ø§Øª</h3>
                    <button id="closeChatBtn" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
                <div id="discussionMessages" class="h-64 overflow-y-auto custom-scrollbar mb-3 text-right text-xs bg-black/40 p-3 rounded-xl border border-white/10"></div>
                <div class="flex gap-2">
                    <input id="discussionInput" type="text" class="flex-1 bg-black/40 border border-white/10 p-2 rounded-lg text-xs outline-none focus:border-cyan-500" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
                    <button id="sendDiscussionBtn" class="dynamic-bg-primary px-4 rounded-lg text-xs font-black">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>

            <h2 class="text-2xl font-black mb-6 text-center neon-text">Ù†Ù‚Ø§Ø´ Ø§Ù„Ø¬ÙˆÙ„Ø© ğŸ—£ï¸</h2>
            
            <!-- Suspects List -->
            <div id="suspectsList" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6"></div>

            <button id="goVoteBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 py-4 rounded-2xl font-black text-sm shadow-xl hover:scale-102 transition-all uppercase tracking-wider border-2 border-purple-400/50">
                Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØµÙˆÙŠØª âœ…
            </button>
            <p id="discussionInfo" class="text-[10px] opacity-60 mt-2 text-center font-bold">
                Ø³ÙŠØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØµÙˆÙŠØª Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¶ØºØ· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„.
            </p>

            <!-- HINT SYSTEM -->
            <div id="hint-section" class="mt-3 flex items-center justify-between p-3 rounded-xl" style="background:rgba(255,215,0,.08);border:2px solid rgba(255,215,0,.2);">
                <div class="flex items-center gap-2">
                    <span style="font-size:20px;">ğŸ’¡</span>
                    <div>
                        <p class="text-xs font-bold text-yellow-400">ØªÙ„Ù…ÙŠØ­ Ù„Ù„Ø£Ø¨Ø±ÙŠØ§Ø¡</p>
                        <p class="text-xs text-gray-400">Ø±ØµÙŠØ¯Ùƒ: <span id="hintBalance" class="text-yellow-400 font-bold">0</span> ØªÙ„Ù…ÙŠØ­</p>
                    </div>
                </div>
                <button id="useHintBtn" onclick="useHint()" class="px-4 py-2 rounded-xl font-black text-xs uppercase transition-all"
                    style="background:linear-gradient(135deg,rgba(255,215,0,.3),rgba(255,165,0,.2));border:2px solid rgba(255,215,0,.5);color:#ffd700;">
                    Ø§Ø³ØªØ®Ø¯Ù… ØªÙ„Ù…ÙŠØ­Ø§Ù‹
                </button>
            </div>
            <div id="hint-display" class="hidden mt-2 p-3 rounded-xl text-center" style="background:rgba(255,215,0,.1);border:2px solid rgba(255,215,0,.3);">
                <p class="text-xs text-gray-400 mb-1">ğŸ’¡ Ø§Ù„ØªÙ„Ù…ÙŠØ­</p>
                <p id="hint-text" class="font-black text-yellow-400"></p>
            </div>
        </div>
    </div>

    <!-- Voting Screen -->
    <div id="voting-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-2xl rounded-[2.5rem] p-6 border border-white/10 shadow-2xl relative">
            <h2 class="text-2xl font-black mb-4 text-center neon-text">Ø§Ù„ØªØµÙˆÙŠØª ğŸ•µï¸â€â™‚ï¸</h2>
            <p class="text-sm opacity-70 mb-4 text-center font-bold">Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ ØªØ´Ùƒ Ø£Ù†Ù‡ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³</p>
            <div id="voteCards" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6"></div>
            <p id="votingStatus" class="text-xs opacity-60 mt-4 text-center font-bold"></p>
        </div>
    </div>

    <!-- Tie Screen -->
    <div id="tie-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/95 backdrop-blur-md animate__animated animate__fadeIn">
        <h1 class="text-8xl font-black text-yellow-500 animate__animated animate__bounceIn" style="text-shadow:0 0 30px rgba(234,179,8,.8);font-family:'Orbitron',sans-serif;">ØªØ¹Ø§Ø¯Ù„! ğŸ¤</h1>
    </div>

    <!-- Spinner Screen -->
    <div id="spinner-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-md rounded-[2.5rem] p-6 border border-white/10 shadow-2xl text-center">
            <h2 class="text-2xl font-black mb-4 neon-text">Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ ğŸ¯</h2>
            <p class="text-sm opacity-70 mb-4">Ø­Ø¯Ø« ØªØ¹Ø§Ø¯Ù„ØŒ Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</p>
            <div id="spinnerWheel" class="relative w-64 h-64 mx-auto mb-6 bg-gradient-to-br from-purple-900 to-pink-900 rounded-full border-4 border-yellow-500 flex items-center justify-center shadow-[0_0_50px_rgba(234,179,8,.5)]">
                <div id="spinnerContent" class="text-3xl font-black text-white"></div>
            </div>
            <button id="startSpinnerBtn" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 py-4 rounded-2xl font-black text-lg shadow-xl hover:scale-105 transition-all border-2 border-yellow-400/50">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨ ğŸ°</button>
        </div>
    </div>

    <!-- Spy Guess Screen -->
    <div id="spy-guess-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-2xl rounded-[2.5rem] p-6 border border-red-500/30 shadow-2xl text-center max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-black mb-2 text-red-500 neon-text" style="text-shadow:0 0 15px rgba(239,68,68,.8);">ğŸ•µï¸ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø§Ù„Ù…ÙƒØ´ÙˆÙ</h2>
            <p id="spyNameDisplay" class="text-xl mb-4 font-bold"></p>
            <p class="text-sm opacity-70 mb-4">Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>
            <div id="categoryWordsList" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6 max-h-96 overflow-y-auto custom-scrollbar"></div>
            <p id="guessResult" class="text-lg font-black mt-4"></p>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-lg rounded-[2.5rem] p-8 border border-white/10 shadow-2xl text-center">
            <div id="resultIcon" class="text-8xl mb-4"></div>
            <h2 id="resultTitle" class="text-3xl font-black mb-2 neon-text"></h2>
            <p id="resultMessage" class="text-lg mb-4 font-bold"></p>
            <!-- Result player summary -->
            <div id="resultPlayerList" class="grid grid-cols-2 gap-2 mb-6 text-left max-h-48 overflow-y-auto custom-scrollbar"></div>
            <button id="returnToRoomBtn" class="w-full dynamic-bg-primary py-4 rounded-2xl font-black shadow-xl uppercase tracking-wider">
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØºØ±ÙØ© ğŸ 
            </button>
        </div>
    </div>

    <!-- Room Overlay (Waiting Room) -->
    <div id="room-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate__animated animate__fadeIn">
        <div class="glass w-full max-w-lg rounded-[2.5rem] p-6 border border-white/10 shadow-2xl relative overflow-y-auto" style="max-height:92dvh;">
            
            <a href="index.html" class="absolute top-4 left-4 text-gray-400 hover:text-cyan-400 transition-colors">
                <i class="fas fa-arrow-right text-xl"></i>
            </a>

            <div class="flex justify-between items-start mb-6 mt-8">
                <div>
                    <h2 class="text-3xl font-black neon-text cursor-pointer" id="roomCodeContainer" title="Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®" style="font-family:'Orbitron',sans-serif;">
                        <span id="displayRoomCode">----</span>
                        <i class="fas fa-copy text-sm opacity-30 hover:opacity-100 transition-opacity"></i>
                    </h2>
                    <p class="text-[9px] opacity-50 uppercase font-bold tracking-widest" style="font-family:'Orbitron',sans-serif;">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</p>
                </div>
                <button id="leaveRoomBtn" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 text-xs px-4 py-2 rounded-xl font-bold border-2 border-red-500/30 transition-all">Ù…ØºØ§Ø¯Ø±Ø©</button>
            </div>

            <div id="host-controls" class="hidden space-y-3 mb-6 glass p-4 rounded-2xl border border-white/5">
                <label class="text-[10px] font-bold opacity-40 uppercase tracking-wider" style="font-family:'Orbitron',sans-serif;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¶ÙŠÙ</label>
                <select id="updateCat" onchange="updateRoomSettings()" class="w-full bg-black/60 text-sm p-3 rounded-xl border-2 border-cyan-500/20 outline-none focus:border-cyan-500 font-bold">
                    <option value="places">ğŸŒ Ø£Ù…Ø§ÙƒÙ† Ø³ÙŠØ§Ø­ÙŠØ©</option>
                    <option value="food">ğŸ• Ø£ÙƒÙ„Ø§Øª Ù…ØµØ±ÙŠØ©</option>
                    <option value="jobs">ğŸ› ï¸ Ù…Ù‡Ù† ÙˆÙˆØ¸Ø§Ø¦Ù</option>
                    <option value="companies">ğŸ¢ Ø´Ø±ÙƒØ§Øª Ø¹Ø§Ù„Ù…ÙŠØ©</option>
                    <option value="football_teams">âš½ Ø£Ù†Ø¯ÙŠØ© ÙˆÙ…Ù†ØªØ®Ø¨Ø§Øª ÙƒÙˆØ±Ø©</option>
                    <!-- custom categories injected here by loadCustomCategories() -->
                </select>
                <div class="flex items-center justify-between bg-black/40 p-3 rounded-xl mb-3 border-2 border-cyan-500/20">
                    <span class="text-xs font-bold">Ù†ÙˆØ¹ Ø§Ù„ØºØ±ÙØ©:</span>
                    <button id="toggleVisibility" onclick="toggleRoomVisibility()" class="text-xs px-4 py-1.5 rounded-full border-2 transition-all font-bold"></button>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <label class="text-[11px] font-bold opacity-50 uppercase tracking-widest" style="font-family:'Orbitron',sans-serif;">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†</label>
                    <span id="pCount" class="text-[11px] font-black dynamic-text-primary" style="font-family:'Orbitron',sans-serif;">0/10</span>
                </div>
                <div id="roomPlayersList" class="space-y-2 custom-scrollbar" style="max-height:260px;overflow-y:auto;padding-right:8px;"></div>
            </div>

            <button id="hostStartBtn" class="hidden w-full btn-main py-4 rounded-2xl font-black shadow-xl disabled:opacity-30 disabled:cursor-not-allowed uppercase tracking-wider">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ ğŸš€</button>
            <div id="guestWaitMsg" class="hidden text-center py-2 opacity-40 animate-pulse text-sm font-bold">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</div>
            <div id="minPlayersMsg" class="hidden text-center text-xs text-yellow-500 mt-2 font-bold">ÙŠØ¬Ø¨ ØªÙˆÙØ± 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp }   from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update, get, remove, onDisconnect, push, serverTimestamp, onChildAdded }
            from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey:            "AIzaSyDnd-pmKEatI3DaFz6xHWB5ucurtHXt9tk",
            authDomain:        "el-jasus.firebaseapp.com",
            databaseURL:       "https://el-jasus-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId:         "el-jasus",
            storageBucket:     "el-jasus.firebasestorage.app",
            messagingSenderId: "415659587906",
            appId:             "1:415659587906:web:782f7940176ea4097eb0db",
            measurementId:     "G-N4K79FP56N"
        };

        const app  = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db   = getDatabase(app);

        let firebase_auth_user = null;
        let _roomInitialized   = false;

        // â”€â”€ Expose Firebase helpers for moderation + voice chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window._firebaseFns = { ref, get, update, onValue, push, serverTimestamp, onChildAdded };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GAME DATA â€” built-in categories (custom ones merged in at runtime)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const gameData = {
            places: [
                "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©", "Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰", "Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†", "Ø§Ù„Ù…Ø·Ø§Ø±", "Ø§Ù„Ù†Ø§Ø¯ÙŠ", "Ø§Ù„Ø³ÙŠÙ†Ù…Ø§", "Ø§Ù„Ù…Ø·Ø¹Ù…", "Ø§Ù„Ø¨Ø­Ø±", "Ø§Ù„Ù…Ø²Ø±Ø¹Ø©", "Ø§Ù„Ø³ÙŠØ±Ùƒ",
                "Ø§Ù„Ù…ÙƒØªØ¨Ø©", "Ø§Ù„Ù…Ø³Ø¬Ø¯", "Ø§Ù„Ù…Ø­Ù„", "Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©", "Ø§Ù„Ø¨Ù†Ùƒ", "Ø§Ù„Ù…Ø­ÙƒÙ…Ø©", "Ø§Ù„Ø³Ø¬Ù†", "Ø§Ù„ØºØ§Ø¨Ø©", "Ø§Ù„ØµØ­Ø±Ø§Ø¡",
                "Ø§Ù„Ø¬Ø¨Ù„", "Ø§Ù„Ù‚Ù„Ø¹Ø©", "Ø§Ù„Ù‚ØµØ±", "Ø§Ù„ÙÙ†Ø¯Ù‚", "Ø§Ù„Ù…ØªØ­Ù", "Ø§Ù„Ù…Ø³Ø±Ø­", "Ø§Ù„Ù…Ø®Ø¨Ø²", "Ø§Ù„Ù…Ù‚Ù‡Ù‰ (Ø§Ù„Ù‚Ù‡ÙˆØ©)", "Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª", "Ù…Ø­Ø·Ø© Ø§Ù„Ù‚Ø·Ø§Ø±",
                "Ù…Ø­Ø·Ø© Ø§Ù„Ù…ØªØ±Ùˆ", "Ø§Ù„ÙˆØ±Ø´Ø©", "Ø§Ù„Ø§Ø³ØªØ§Ø¯", "Ø§Ù„Ø¬ÙŠÙ…", "Ø§Ù„Ø­Ø¶Ø§Ù†Ø©", "Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©", "ØµØ§Ù„ÙˆÙ† Ø§Ù„Ø­Ù„Ø§Ù‚Ø©", "Ø§Ù„Ù…Ø¹Ù…Ù„", "Ø§Ù„Ù…Ù†Ø²Ù„", "Ø§Ù„Ù…Ø·Ø¨Ø®",
                "ØºØ±ÙØ© Ø§Ù„Ù†ÙˆÙ…", "Ø§Ù„Ø­Ù…Ø§Ù…", "Ø§Ù„Ø³Ø·ÙˆØ­", "Ø§Ù„Ø´Ø§Ø±Ø¹", "Ø§Ù„ÙƒÙˆØ¨Ø±ÙŠ", "Ø§Ù„Ù…ÙŠÙ†Ø§Ø¡", "Ø§Ù„Ø³ÙØ§Ø±Ø©", "Ø§Ù„Ù…Ø±ØµØ¯", "Ø§Ù„Ù…Ø®ÙŠÙ…", "Ø§Ù„Ø´Ù„Ø§Ù„",
                "Ø§Ù„Ø¨Ø­ÙŠØ±Ø©", "Ø§Ù„ÙƒÙ‡Ù", "Ø§Ù„Ù…Ø³Ø¨Ø­ (Ø§Ù„Ø¨ÙŠØ³ÙŠÙ†)", "Ø§Ù„Ù…ØµÙ†Ø¹", "Ø§Ù„Ù…ÙƒØªØ¨", "Ø§Ù„Ø£ØªÙˆØ¨ÙŠØ³", "Ø§Ù„Ø·ÙŠØ§Ø±Ø©", "Ø§Ù„Ù…Ø±ÙƒØ¨", "Ø§Ù„ÙØ¶Ø§Ø¡", "Ø§Ù„Ù‚Ù…Ø±",
                "Ø§Ù„Ù…Ø±ÙŠØ®", "Ø§Ù„Ø³ÙˆÙ‚", "Ø§Ù„Ù…Ù„Ø§Ù‡ÙŠ", "Ø­Ø¯ÙŠÙ‚Ø© Ø¹Ø§Ù…Ø©", "Ø§Ù„Ø´Ù‚Ø©", "Ø§Ù„ÙÙŠÙ„Ø§", "Ø§Ù„Ø®ÙŠÙ…Ø©", "Ø§Ù„Ø¬Ø±Ø§Ø¬", "Ø§Ù„Ù…ØµÙ„Ø­Ø© Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ©", "Ø§Ù„Ø¨Ø±ÙŠØ¯",
                "Ù‚Ø³Ù… Ø§Ù„Ø´Ø±Ø·Ø©", "Ø§Ù„Ù…Ø·Ø§ÙØ¦", "Ø§Ù„Ø¥Ø³Ø¹Ø§Ù", "Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©", "Ø§Ù„Ù…ÙˆÙ„", "Ù…Ø­Ù„ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª", "Ø§Ù„Ø³Ø§ÙŠØ¨Ø±", "Ø§Ø³ØªÙˆØ¯ÙŠÙˆ ØªØµÙˆÙŠØ±", "Ù‚Ø§Ø¹Ø© Ø£ÙØ±Ø§Ø­", "Ø¹Ø²Ø§Ø¡",
                "Ù…Ø¹Ø±Ø¶ Ø³ÙŠØ§Ø±Ø§Øª", "Ù…Ø­Ù„ ÙˆØ±Ø¯", "Ù…Ø­Ù„ Ù‡Ø¯Ø§ÙŠØ§", "ÙƒØ´Ùƒ", "Ø¨Ù†Ø²ÙŠÙ†Ø©", "Ù…ÙˆÙ‚Ù Ù…ÙŠÙƒØ±ÙˆØ¨Ø§ØµØ§Øª", "Ù…ØºØ³Ù„Ø© Ø³ÙŠØ§Ø±Ø§Øª", "Ù…Ø­Ù„ Ø­Ù„ÙˆÙŠØ§Øª", "ÙØ±Ù† Ø¹ÙŠØ´", "Ù…Ø­Ù„ Ø³Ù…Ùƒ",
                "Ù…Ø­Ù„ Ø¬Ø²Ø§Ø±Ø©", "Ù…Ø­Ù„ Ø¨Ù‚Ø§Ù„Ø©", "ØµØ§Ù„Ø© Ø¨ÙˆÙ„ÙŠÙ†Ø¬", "ØªÙ†Ø³ Ø·Ø§ÙˆÙ„Ø©", "Ù…Ù„Ø¹Ø¨ ÙƒÙˆØ±Ø©", "Ø§Ù„Ø¨ÙˆØ±ØµØ©", "Ø§Ù„Ù…Ø¯Ø¨Ø­", "Ø§Ù„Ø¬Ø²ÙŠØ±Ø©", "Ø§Ù„Ù…Ù†Ø§Ø±Ø©", "Ø§Ù„Ù…Ù‚Ø§Ø¨Ø±"
            ],
            football_teams: [
                "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙŠ", "Ø§Ù„Ø²Ù…Ø§Ù„Ùƒ", "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠ", "Ø§Ù„Ù…ØµØ±ÙŠ Ø§Ù„Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ÙŠ", "Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø³ÙƒÙ†Ø¯Ø±ÙŠ", "Ø¨ÙŠØ±Ø§Ù…ÙŠØ¯Ø²", "Ø³Ù…ÙˆØ­Ø©", "Ù…ÙˆØ¯Ø±Ù† ÙÙŠÙˆØªØ´Ø±", "Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ† Ø§Ù„Ø¹Ø±Ø¨", "ØºØ²Ù„ Ø§Ù„Ù…Ø­Ù„Ø©", "Ø§Ù„Ø¬ÙˆÙ†Ø©", "Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ", "Ø³ÙŠØ±Ø§Ù…ÙŠÙƒØ§ ÙƒÙ„ÙŠÙˆØ¨Ø§ØªØ±Ø§", "Ø¥Ù†Ø¨ÙŠ", "Ø·Ù„Ø§Ø¦Ø¹ Ø§Ù„Ø¬ÙŠØ´", "Ø­Ø±Ø³ Ø§Ù„Ø­Ø¯ÙˆØ¯", "Ø£Ø³ÙˆØ§Ù†",
                "Ø§Ù„Ù‡Ù„Ø§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ", "Ø§Ù„Ù†ØµØ± Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ", "Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ", "Ø§Ù„Ø£Ù‡Ù„ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ", "Ø§Ù„Ø´Ø¨Ø§Ø¨ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ", "Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ø¥Ù…Ø§Ø±Ø§ØªÙŠ", "Ø´Ø¨Ø§Ø¨ Ø§Ù„Ø£Ù‡Ù„ÙŠ", "Ø§Ù„ÙˆØ¯Ø§Ø¯ Ø§Ù„Ù…ØºØ±Ø¨ÙŠ", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…ØºØ±Ø¨ÙŠ", "Ø§Ù„Ø¬ÙŠØ´ Ø§Ù„Ù…Ù„ÙƒÙŠ", "Ø§Ù„ØªØ±Ø¬ÙŠ Ø§Ù„ØªÙˆÙ†Ø³ÙŠ", "Ø§Ù„Ù†Ø¬Ù… Ø§Ù„Ø³Ø§Ø­Ù„ÙŠ", "Ø§Ù„Ø¥ÙØ±ÙŠÙ‚ÙŠ Ø§Ù„ØªÙˆÙ†Ø³ÙŠ", "Ø§Ù„Ø³Ø¯ Ø§Ù„Ù‚Ø·Ø±ÙŠ", "Ø§Ù„Ø¯Ø­ÙŠÙ„", "Ø§Ù„ÙƒÙˆÙŠØª Ø§Ù„ÙƒÙˆÙŠØªÙŠ", "Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© Ø§Ù„ÙƒÙˆÙŠØªÙŠ", "Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø£Ø±Ø¯Ù†ÙŠ", "Ø§Ù„Ø²ÙˆØ±Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ",
                "Ù„ÙŠÙØ±Ø¨ÙˆÙ„", "Ù…Ø§Ù†Ø´Ø³ØªØ± Ø³ÙŠØªÙŠ", "Ù…Ø§Ù†Ø´Ø³ØªØ± ÙŠÙˆÙ†Ø§ÙŠØªØ¯", "Ø£Ø±Ø³Ù†Ø§Ù„", "ØªØ´ÙŠÙ„Ø³ÙŠ", "ØªÙˆØªÙ†Ù‡Ø§Ù…", "Ø£Ø³ØªÙˆÙ† ÙÙŠÙ„Ø§", "Ù†ÙŠÙˆÙƒØ§Ø³Ù„ ÙŠÙˆÙ†Ø§ÙŠØªØ¯", "Ù„ÙŠØ³ØªØ± Ø³ÙŠØªÙŠ", "ÙˆØ³Øª Ù‡Ø§Ù…",
                "Ø±ÙŠØ§Ù„ Ù…Ø¯Ø±ÙŠØ¯", "Ø¨Ø±Ø´Ù„ÙˆÙ†Ø©", "Ø£ØªÙ„ØªÙŠÙƒÙˆ Ù…Ø¯Ø±ÙŠØ¯", "Ø¥Ø´Ø¨ÙŠÙ„ÙŠØ©", "ÙØ§Ù„Ù†Ø³ÙŠØ§", "Ø±ÙŠØ§Ù„ Ø³ÙˆØ³ÙŠØ¯Ø§Ø¯", "ÙÙŠØ§Ø±ÙŠØ§Ù„", "Ø¨ÙŠÙ„Ø¨Ø§Ùˆ",
                "ÙŠÙˆÙÙ†ØªÙˆØ³", "Ø¥ÙŠÙ‡ Ø³ÙŠ Ù…ÙŠÙ„Ø§Ù†", "Ø¥Ù†ØªØ± Ù…ÙŠÙ„Ø§Ù†", "Ù†Ø§Ø¨ÙˆÙ„ÙŠ", "Ø±ÙˆÙ…Ø§", "Ù„Ø§ØªØ³ÙŠÙˆ", "ÙÙŠÙˆØ±Ù†ØªÙŠÙ†Ø§", "Ø¨Ø§ÙŠØ±Ù† Ù…ÙŠÙˆÙ†Ø®", "Ø¨ÙˆØ±ÙˆØ³ÙŠØ§ Ø¯ÙˆØ±ØªÙ…ÙˆÙ†Ø¯", "Ø¨Ø§ÙŠØ± Ù„ÙŠÙØ±ÙƒÙˆØ²Ù†", "Ù„Ø§ÙŠØ¨Ø²ÙŠØ¬", "Ø¨Ø§Ø±ÙŠØ³ Ø³Ø§Ù† Ø¬ÙŠØ±Ù…Ø§Ù†", "Ù…Ø§Ø±Ø³ÙŠÙ„ÙŠØ§", "Ù„ÙŠÙˆÙ†", "Ù…ÙˆÙ†Ø§ÙƒÙˆ", "Ø£ÙŠØ§ÙƒØ³ Ø£Ù…Ø³ØªØ±Ø¯Ø§Ù…", "Ø¨Ù†ÙÙŠÙƒØ§", "Ø¨ÙˆØ±ØªÙˆ",
                "Ù…Ù†ØªØ®Ø¨ Ù…ØµØ±", "Ù…Ù†ØªØ®Ø¨ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©", "Ù…Ù†ØªØ®Ø¨ Ø§Ù„Ù…ØºØ±Ø¨", "Ù…Ù†ØªØ®Ø¨ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "Ù…Ù†ØªØ®Ø¨ ØªÙˆÙ†Ø³", "Ù…Ù†ØªØ®Ø¨ Ù‚Ø·Ø±", "Ù…Ù†ØªØ®Ø¨ Ø§Ù„Ø¨Ø±Ø§Ø²ÙŠÙ„", "Ù…Ù†ØªØ®Ø¨ Ø§Ù„Ø£Ø±Ø¬Ù†ØªÙŠÙ†", "Ù…Ù†ØªØ®Ø¨ ÙØ±Ù†Ø³Ø§", "Ù…Ù†ØªØ®Ø¨ Ø£Ù„Ù…Ø§Ù†ÙŠØ§", "Ù…Ù†ØªØ®Ø¨ Ø¥Ø³Ø¨Ø§Ù†ÙŠØ§", "Ù…Ù†ØªØ®Ø¨ Ø¥ÙŠØ·Ø§Ù„ÙŠØ§", "Ù…Ù†ØªØ®Ø¨ Ø¥Ù†Ø¬Ù„ØªØ±Ø§", "Ù…Ù†ØªØ®Ø¨ Ø§Ù„Ø¨Ø±ØªØºØ§Ù„", "Ù…Ù†ØªØ®Ø¨ Ø¨Ù„Ø¬ÙŠÙƒØ§", "Ù…Ù†ØªØ®Ø¨ ÙƒØ±ÙˆØ§ØªÙŠØ§", "Ù…Ù†ØªØ®Ø¨ Ù‡ÙˆÙ„Ù†Ø¯Ø§", "Ù…Ù†ØªØ®Ø¨ Ø§Ù„Ø£ÙˆØ±ÙˆØºÙˆØ§ÙŠ", "Ù…Ù†ØªØ®Ø¨ Ø§Ù„ÙŠØ§Ø¨Ø§Ù†", "Ù…Ù†ØªØ®Ø¨ ÙƒÙˆØ±ÙŠØ§ Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©", "Ù…Ù†ØªØ®Ø¨ Ø§Ù„Ø³Ù†ØºØ§Ù„", "Ù…Ù†ØªØ®Ø¨ Ù†ÙŠØ¬ÙŠØ±ÙŠØ§", "Ù…Ù†ØªØ®Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±ÙˆÙ†"
            ],
            food: [
                "ÙƒØ´Ø±ÙŠ", "Ù…Ù„ÙˆØ®ÙŠØ©", "ÙÙˆÙ„", "Ø·Ø¹Ù…ÙŠØ© (ÙÙ„Ø§ÙÙ„)", "ÙØªØ© Ø¨Ø§Ù„Ù„Ø­Ù…Ø©", "Ø­ÙˆØ§ÙˆØ´ÙŠ", "Ù…Ø­Ø´ÙŠ ÙƒØ±Ù†Ø¨", "Ù…Ø­Ø´ÙŠ ÙˆØ±Ù‚ Ø¹Ù†Ø¨", "Ù…Ù…Ø¨Ø§Ø±", "ÙƒÙˆØ§Ø±Ø¹",
                "ÙØªØ© ÙƒÙˆØ§Ø±Ø¹", "ÙƒÙØªØ© Ù…Ø´ÙˆÙŠØ©", "Ø·Ø±Ø¨", "ÙƒØ¨Ø§Ø¨", "ÙƒØ¨Ø¯Ø© Ø¥Ø³ÙƒÙ†Ø¯Ø±Ø§Ù†ÙŠ", "Ø³Ø¬Ù‚ Ø´Ø±Ù‚ÙŠ", "Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø´Ø§Ù…ÙŠÙ„", "Ø±Ù‚Ø§Ù‚ Ø¨Ø§Ù„Ù„Ø­Ù…Ø©", "Ø¬Ù„Ø§Ø´", "Ø£Ø±Ø² Ø¨Ù„Ø¨Ù†",
                "Ø£Ù… Ø¹Ù„ÙŠ", "Ø¨Ø³Ø¨ÙˆØ³Ø©", "ÙƒÙ†Ø§ÙØ©", "Ù„Ù‚ÙŠÙ…Ø§Øª (Ù‚Ø§Ø¶ÙŠ)", "ÙØ·ÙŠØ± Ù…Ø´Ù„ØªØª", "Ù…Ø´ ÙˆØ¬Ø¨Ù†Ø© Ù‚Ø¯ÙŠÙ…Ø©", "Ø¹Ø³Ù„ Ø£Ø³ÙˆØ¯ ÙˆØ·Ø­ÙŠÙ†Ø©", "ÙƒØ´Ùƒ", "Ø¨ØµØ§Ø±Ø©", "Ø¹Ø¯Ø³",
                "Ø´ÙˆØ±Ø¨Ø© Ù„Ø³Ø§Ù† Ø¹ØµÙÙˆØ±", "Ø£Ø±Ø² Ù…Ø¹Ù…Ø±", "Ù…Ø³Ù‚Ø¹Ø©", "ØªÙˆØ±Ù„ÙŠ Ø®Ø¶Ø§Ø±", "Ø¨Ø§Ù…ÙŠØ© Ø¨Ø§Ù„Ù„Ø­Ù…Ø©", "Ù‚Ù„Ù‚Ø§Ø³", "Ø³Ø¨Ø§Ù†Ø®", "Ø£Ø±Ø² Ø¨Ø§Ù„Ø´Ø¹Ø±ÙŠØ©", "ÙØ±Ø§Ø® Ù…Ø­Ù…Ø±Ø©", "Ø­Ù…Ø§Ù… Ù…Ø­Ø´ÙŠ",
                "Ø¨Ø·", "Ø£Ø±Ø§Ù†Ø¨", "Ø³Ù…Ùƒ Ø¨Ù„Ø·ÙŠ", "Ø³Ù…Ùƒ Ø¨ÙˆØ±ÙŠ", "Ø¬Ù…Ø¨Ø±ÙŠ", "Ø³Ø¨ÙŠØ·", "ÙØ³ÙŠØ®", "Ø±Ù†Ø¬Ø©", "Ù…Ù„ÙˆØ­Ø©", "Ø¨Ø·Ø§Ø·Ø³ Ù…Ø­Ù…Ø±Ø©", "Ø¨Ø§Ø¨Ø§ ØºÙ†ÙˆØ¬", "Ø³Ù„Ø·Ø© Ø®Ø¶Ø±Ø§Ø¡", "Ù…Ø®Ù„Ù„ (Ø·Ø±Ø´ÙŠ)",
                "Ø¨Ø§Ø°Ù†Ø¬Ø§Ù† Ù…Ø®Ù„Ù„", "Ø¨ÙŠØ¶ Ø¨Ø§Ù„Ø¨Ø³Ø·Ø±Ù…Ø©", "Ø´ÙƒØ´ÙˆÙƒØ©", "Ø¹Ø¬Ø©", "Ù…Ø® Ø¨Ø§Ù†ÙŠÙ‡", "ÙƒØ¨Ø¯Ø© ÙˆÙ‚ÙˆØ§Ù†Øµ", "ÙƒÙØªØ©",
                "ÙƒÙØªØ© Ø£Ø±Ø²", "Ø£Ø±Ø² ØµÙŠØ§Ø¯ÙŠØ©", "ÙƒÙŠÙƒØ© Ø¨Ø±ØªÙ‚Ø§Ù„", "Ø±Ø² Ø¨Ù„Ø¨Ù†", "Ù…Ù‡Ù„Ø¨ÙŠØ©", "Ù‚Ù…Ø± Ø§Ù„Ø¯ÙŠÙ†", "Ø¹Ø§Ø´ÙˆØ±Ø§", "Ø²Ù„Ø§Ø¨ÙŠØ§", "Ø¨Ù„Ø­ Ø§Ù„Ø´Ø§Ù…", "ØµÙˆØ§Ø¨Ø¹ Ø²ÙŠÙ†Ø¨",
                "ÙƒØ­Ùƒ Ø§Ù„Ø¹ÙŠØ¯", "Ø¨Ø³ÙƒÙˆÙŠØª Ù†Ø´Ø§Ø¯Ø±", "ØºØ±ÙŠØ¨Ø©", "Ø¨ÙŠØªÙŠÙÙˆØ±", "Ù…Ù†ÙŠÙ† (Ù‚Ø±Ø§Ù‚ÙŠØ´)", "Ù‚Ø±Øµ Ø¨Ø¹Ø¬ÙˆØ©", "Ø¹ÙŠØ´ Ø¨Ù„Ø¯ÙŠ", "Ø¹ÙŠØ´ ÙÙŠÙ†Ùˆ", "Ø´Ø§ÙˆØ±Ù…Ø§ Ù…ØµØ±ÙŠ", "ÙØ±Ø§Ø® Ø¨Ø§Ù†ÙŠÙ‡",
                "ØµÙŠÙ†ÙŠØ© Ø¨Ø·Ø§Ø·Ø³", "Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„ØµÙ„ØµØ©", "Ø³Ø§Ù†Ø¯ÙˆØªØ´ Ø¬Ø¨Ù†Ø©", "Ø´Ø§ÙŠ Ø¨Ù„Ø¨Ù†", "Ø³Ø­Ù„Ø¨", "Ø¹ØµÙŠØ± Ù‚ØµØ¨", "Ø¹Ø±Ù‚Ø³ÙˆØ³", "ØªÙ…Ø±Ù‡Ù†Ø¯ÙŠ", "Ø®Ø±ÙˆØ¨", "Ø³ÙˆØ¨ÙŠØ§",
                "Ù…Ø¯Ù…Ø³", "Ø¨ÙŠØ¶ Ù…Ø³Ù„ÙˆÙ‚", "Ø¬Ø¨Ù†Ø© Ø¨ÙŠØ¶Ø§", "Ù„Ø§Ù†Ø´ÙˆÙ†", "Ø¨Ø³Ø·Ø±Ù…Ø©", "Ù…Ø®Ø±ÙˆØ·Ø©", "ÙƒÙˆØ³Ø© Ø¨Ø§Ù„Ø¨Ø´Ø§Ù…ÙŠÙ„", "Ø£Ø±Ø² Ø¨Ø§Ù„Ø®Ù„Ø·Ø©", "ÙƒØ¨Ø¯Ø© Ø¬Ù…Ù„ÙŠ", "ÙØ±ÙŠÙƒ"
            ],
            jobs: [
                "Ø¯ÙƒØªÙˆØ±", "Ù…Ù‡Ù†Ø¯Ø³", "Ù…Ø¯Ø±Ø³", "Ø¶Ø§Ø¨Ø·", "Ù…Ø­Ø§Ù…ÙŠ", "Ù…Ø­Ø§Ø³Ø¨", "Ù…Ù…Ø±Ø¶", "ØµÙŠØ¯Ù„ÙŠ", "Ø·ÙŠØ§Ø±", "Ø³ÙˆØ§Ù‚",
                "Ù†Ø¬Ø§Ø±", "Ø³Ø¨Ø§Ùƒ", "ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ", "Ù†Ù‚Ø§Ø´", "Ø¨Ù†Ø§", "Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ", "Ø­Ù„Ø§Ù‚", "Ø®ÙŠØ§Ø·", "Ø·Ø¨Ø§Ø®", "Ø¬Ø²Ø§Ø±",
                "Ø¨Ø§Ø¦Ø¹", "ØµØ­ÙÙŠ", "Ù…Ø°ÙŠØ¹", "Ù…Ù…Ø«Ù„", "Ù…ØºÙ†ÙŠ", "Ø±Ø³Ø§Ù…", "Ù…ØµÙˆØ±", "Ù„Ø§Ø¹Ø¨ ÙƒÙˆØ±Ø©", "Ù…Ø¯Ø±Ø¨", "Ø­ÙƒÙ…",
                "Ø¹Ø§Ù…Ù„ Ù†Ø¸Ø§ÙØ©", "Ø¨ÙˆØ§Ø¨", "Ø¹Ø§Ù…Ù„ Ø¯Ù„ÙŠÙØ±ÙŠ", "Ù†Ø¬Ø§Ø± Ù…Ø³Ù„Ø­", "Ø­Ø¯Ø§Ø¯", "ÙÙ„Ø§Ø­", "ØµÙŠØ§Ø¯", "Ù‚Ø§Ø¶ÙŠ", "Ø±Ø¬Ù„ Ø¥Ø·ÙØ§Ø¡", "Ø¹Ø³ÙƒØ±ÙŠ",
                "Ù…Ø£Ø°ÙˆÙ†", "Ø¥Ù…Ø§Ù… Ù…Ø³Ø¬Ø¯", "Ù‚Ø³ÙŠØ³", "Ù…Ø£Ù„Ù", "Ø´Ø§Ø¹Ø±", "Ù…Ø®Ø±Ø¬", "Ù…ÙˆÙ†ØªÙŠØ±", "Ù…ØµÙ…Ù… Ø¬Ø±Ø§ÙÙŠÙƒ", "Ù…Ø¨Ø±Ù…Ø¬", "Ù‡ÙƒØ±",
                "Ø¹Ø§Ù„Ù…", "Ø±Ø§Ø¦Ø¯ ÙØ¶Ø§Ø¡", "ØºØ·Ø§Ø³", "Ø·ÙŠØ§Ø± Ø­Ø±Ø¨ÙŠ", "Ù…Ø¶ÙŠÙØ© Ø·ÙŠØ±Ø§Ù†", "Ù…ØªØ±Ø¬Ù…", "Ø³ÙƒØ±ØªÙŠØ±", "Ù…Ø¯ÙŠØ±", "ÙˆØ²ÙŠØ±", "Ø±Ø¦ÙŠØ³",
                "Ø®Ø¨ÙŠØ± ØªØ¬Ù…ÙŠÙ„", "Ù…ÙˆØ¯ÙŠÙ„", "ÙŠÙˆØªÙŠÙˆØ¨Ø±", "ØªÙŠÙƒØªÙˆÙƒØ±", "Ø¨Ù„ÙˆØ¬Ø±", "Ø¹Ø§Ù…Ù„ Ø¨Ù†Ø²ÙŠÙ†Ø©", "ØµØ±Ø§Ù", "Ø¬Ø±Ø³ÙˆÙ†", "Ø´ÙŠÙ", "Ø­Ù„ÙˆØ§Ù†ÙŠ",
                "Ø®ÙÙŠØ±", "Ø¨ÙˆØ¯ÙŠ Ø¬Ø§Ø±Ø¯", "Ù…Ø­Ù‚Ù‚", "Ø¬Ø§Ø³ÙˆØ³", "Ø±Ø¬Ù„ Ø£Ø¹Ù…Ø§Ù„", "Ø¨Ø§Ø¦Ø¹ Ø®Ø¶Ø§Ø±", "Ø¨Ø§Ø¦Ø¹ ÙØ§ÙƒÙ‡Ø©", "Ø¨Ø§Ø¦Ø¹ Ù„Ø¨Ù†", "Ù…ÙƒÙˆØ¬ÙŠ", "Ù…Ù†Ø¬Ø¯",
                "Ø¹Ø§Ù…Ù„ Ø¨Ù†Ø§Ø¡", "ÙÙ†ÙŠ ØªÙƒÙŠÙŠÙ", "ÙÙ†ÙŠ Ø±Ø§Ø¯ÙŠÙˆ", "Ø³Ø§Ø­Ø±", "Ù…Ù‡Ø±Ø¬", "Ø±Ø§Ù‚Øµ", "Ù…Ø¯Ø±Ø¨ Ø¬ÙŠÙ…", "Ø³Ø¨Ø§Ø­ Ù…Ø­ØªØ±Ù", "Ø¹Ø§Ù…Ù„ Ù…Ù†Ø¬Ù…", "Ø¹Ø§Ù…Ù„ Ø´Ø­Ù†",
                "Ø³Ø§Ø¹ÙŠ Ø¨Ø±ÙŠØ¯", "Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„", "Ø·Ø¨ÙŠØ¨ Ø¨ÙŠØ·Ø±ÙŠ", "Ø·Ø¨ÙŠØ¨ Ø£Ø³Ù†Ø§Ù†", "Ø·Ø¨ÙŠØ¨ Ø¹ÙŠÙˆÙ†", "Ù…Ø­Ù„Ù„ ÙƒÙˆØ±Ø©", "Ø³Ù…Ø³Ø§Ø±", "ØªØ§Ø¬Ø±", "Ù…Ù‚Ø§ÙˆÙ„", "Ø·ÙŠØ§Ø± Ø¯Ø±ÙˆÙ†"
            ],
            companies: [
                "Apple", "Google", "Microsoft", "Amazon", "Facebook", "Instagram", "WhatsApp", "YouTube", "TikTok", "Netflix",
                "Samsung", "Huawei", "Xiaomi", "Oppo", "Sony", "LG", "Dell", "HP", "Intel", "Canon",
                "Tesla", "Toyota", "Mercedes", "BMW", "Audi", "Ferrari", "Lamborghini", "Ford", "Chevrolet", "Jeep",
                "Nike", "Adidas", "Puma", "Zara", "H&M", "Gucci", "Prada", "Rolex", "Lacoste", "Chanel",
                "McDonald's", "KFC", "Burger King", "Pizza Hut", "Subway", "Starbucks", "Pepsi", "Coca-Cola", "Red Bull", "KitKat",
                "Disney", "Marvel", "DC Comics", "Warner Bros", "Paramount", "Pixar", "Universal", "Spotify", "Snapchat", "Telegram",
                "Visa", "Mastercard", "PayPal", "Binance", "eBay", "Alibaba", "AliExpress", "Shein", "Noon",
                "Uber", "Careem", "Airbnb", "Booking", "FedEx", "DHL", "Aramex", "IKEA", "Walmart", "Carrefour",
                "Nestle", "Dove", "Nivea", "L'Oreal", "Johnson's", "Colgate", "Gillette", "Casio", "Nikon",
                "Lego", "Barbie", "Hot Wheels", "PlayStation", "Xbox", "Nintendo", "Zoom", "Skype", "Slack", "LinkedIn"
            ]
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PLAYER PROFILE CACHE â€” name â†’ { rank, nameTheme, nameTag }
        // Loaded once at init, used in all game stage renderers
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const playerProfileCache = {};

        const RANK_BADGES = {
            Bronze:   { icon: 'ğŸ¥‰', color: '#cd7f32' },
            Silver:   { icon: 'ğŸ¥ˆ', color: '#c0c0c0' },
            Gold:     { icon: 'ğŸ¥‡', color: '#ffd700' },
            Platinum: { icon: 'ğŸ’ ', color: '#00e5ff' },
            Diamond:  { icon: 'ğŸ’', color: '#b9f2ff' },
        };

        async function buildPlayerProfileCache(playerNames) {
            try {
                const snap = await get(ref(db, 'players'));
                if (!snap.exists()) return;
                snap.forEach(child => {
                    const p     = child.val();
                    // Players are stored by UID; match by any name field
                    const pName = p.displayName || p.username || p.name || '';
                    const cleanName = pName.replace(' (Ø®Ø§Ù…Ù„)', '').trim();
                    if (cleanName && playerNames.some(n => n.replace(' (Ø®Ø§Ù…Ù„)', '').trim() === cleanName)) {
                        playerProfileCache[cleanName] = {
                            rank:      p.rank      || 'Bronze',
                            nameTheme: p.nameTheme || null,
                            nameTag:   p.nameTag   || null,
                            rankPoints: p.rankPoints || 0,
                        };
                    }
                });
            } catch(e) { console.warn('[room] profile cache build failed:', e); }
        }

        /**
         * getPlayerHTML â€” returns rich HTML for a player name with rank badge + theme
         * Used in ALL game stages: waiting room, discussion, voting, spy guess, result
         */
        function getPlayerHTML(name, opts = {}) {
            const { isHost = false, isMe = false, isIdle = false, large = false } = opts;
            const cleanName = name.replace(' (Ø®Ø§Ù…Ù„)', '').trim();
            const profile   = playerProfileCache[cleanName];
            const rank      = profile?.rank || 'Bronze';
            const badge     = RANK_BADGES[rank] || RANK_BADGES.Bronze;
            const nameStyle = profile?.nameTheme
                ? `color:${profile.nameTheme};text-shadow:0 0 10px ${profile.nameTheme}66;`
                : '';
            const tagHtml = profile?.nameTag
                ? `<span class="player-nametag">${profile.nameTag}</span>`
                : '';
            const nameSize = large ? 'font-size:1.1em;' : '';

            return `
                <div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap;">
                    ${tagHtml}
                    <span style="font-weight:900;${nameSize}${nameStyle}">${cleanName}</span>
                    <span class="player-rank-badge" title="${rank}">${badge.icon}</span>
                    ${isHost ? '<i class="fas fa-crown" style="font-size:13px;color:#ffd700;filter:drop-shadow(0 0 6px rgba(255,215,0,.8));"></i>' : ''}
                    ${isMe   ? '<span style="font-size:10px;color:#00f2ff;font-weight:700;">(Ø£Ù†Øª)</span>' : ''}
                    ${isIdle ? '<span style="font-size:10px;color:#666;"> (Ø®Ø§Ù…Ù„)</span>' : ''}
                </div>`;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOAD CUSTOM CATEGORIES from Firebase wordLists
        // Merges into gameData + injects options into host dropdown
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadCustomCategories() {
            try {
                const snap = await get(ref(db, 'wordLists'));
                if (!snap.exists()) return;
                const builtIn = ['places','food','jobs','companies','football_teams'];
                const select  = document.getElementById('updateCat');

                // Remove previously injected custom options
                select?.querySelectorAll('option[data-custom]').forEach(o => o.remove());

                snap.forEach(child => {
                    const catId  = child.key;
                    const catVal = child.val();
                    if (!catVal.words) return;
                    const words = Array.isArray(catVal.words) ? catVal.words : Object.values(catVal.words);
                    if (!words.length) return;

                    if (builtIn.includes(catId)) {
                        // Merge extra words into built-in category
                        const newWords = words.filter(w => !gameData[catId]?.includes(w));
                        if (newWords.length) gameData[catId] = [...(gameData[catId] || []), ...newWords];
                    } else {
                        // Entirely new custom category
                        gameData[catId] = words;
                        if (select) {
                            const opt = document.createElement('option');
                            opt.value          = catId;
                            opt.textContent    = `${catVal.emoji || 'ğŸ—‚ï¸'} ${catVal.name || catId}`;
                            opt.dataset.custom = 'true';
                            select.appendChild(opt);
                        }
                    }
                });
            } catch(e) { console.warn('[room] loadCustomCategories failed:', e); }
        }

        // â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showToast(msg, duration = 3000) {
            const t = document.createElement('div');
            t.style.cssText = `
                position:fixed;bottom:100px;left:50%;transform:translateX(-50%);z-index:9999;
                background:rgba(0,0,0,.75);border:1.5px solid rgba(0,242,255,.4);border-radius:14px;
                padding:10px 22px;font-family:'Cairo',sans-serif;font-size:13px;font-weight:700;
                color:#fff;backdrop-filter:blur(14px);text-align:center;white-space:nowrap;
                animation:_toast_in .3s ease;`;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => {
                t.style.opacity    = '0';
                t.style.transition = 'opacity .4s';
                setTimeout(() => t.remove(), 450);
            }, duration);
        }
        window.showToast = showToast;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ROOM STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let myName = localStorage.getItem('eljasus_user_name') || "";
        let myRoom = localStorage.getItem('currentRoom') || "";
        let isHost = localStorage.getItem('isHost') === 'true';

        const pendingRoom = localStorage.getItem('pendingRoomJoin');
        if (pendingRoom) {
            myRoom = pendingRoom;
            localStorage.removeItem('pendingRoomJoin');
            localStorage.setItem('currentRoom', myRoom);
        }

        if (!myRoom || !myName) { window.location.href = 'index.html'; }

        function toArray(val) {
            if (!val) return [];
            if (Array.isArray(val)) return val;
            return Object.values(val);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTH + INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'login.html'; return; }

            window._firebaseFns = { ref, get, update, onValue, push, serverTimestamp, onChildAdded };

            if (window.MOD) {
                await MOD.init(db, user);
                if (document.getElementById('_ej_ban')) return;
            }

            firebase_auth_user = user;

            if (!_roomInitialized) {
                _roomInitialized = true;
                // Load custom categories BEFORE initialising the room
                // so gameData is complete when game starts
                await loadCustomCategories();
                joinPendingAndInit();
            }
        });

        async function joinPendingAndInit() {
            if (pendingRoom) {
                try {
                    const snap = await get(ref(db, 'rooms/' + myRoom));
                    if (snap.exists()) {
                        const d = snap.val();
                        const players = toArray(d.players);
                        if (!players.includes(myName) && players.length < 10) {
                            await update(ref(db, 'rooms/' + myRoom), { players: [...players, myName] });
                        }
                        isHost = false;
                        localStorage.setItem('isHost', 'false');
                    } else {
                        alert('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                        window.location.href = 'index.html'; return;
                    }
                } catch(e) {
                    alert('ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©: ' + e.message);
                    window.location.href = 'index.html'; return;
                }
            }
            setupPresence(myRoom, myName);
            initRoom();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HELPER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function hideAllGameScreens() {
            ['game-screen','discussion-screen','voting-screen','tie-screen',
             'spinner-screen','spy-guess-screen','result-screen','room-overlay']
             .forEach(id => document.getElementById(id)?.classList.add('hidden'));
        }

        function setupPresence(roomCode, playerName) {
            onValue(ref(db, '.info/connected'), (snap) => {
                if (snap.val() !== true) return;
                const roomRef = ref(db, `rooms/${roomCode}`);
                onDisconnect(roomRef).get().then((snapshot) => {
                    if (!snapshot.exists()) return;
                    const data = snapshot.val();
                    if (data.host === playerName) {
                        onDisconnect(roomRef).remove();
                    } else {
                        let updated = toArray(data.players).map(p =>
                            p === playerName ? `${playerName} (Ø®Ø§Ù…Ù„)` : p);
                        onDisconnect(ref(db, `rooms/${roomCode}/players`)).set(updated);
                    }
                });
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MAIN ROOM LISTENER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initRoom() {
            const roomRef = ref(db, 'rooms/' + myRoom);
            onValue(roomRef, async (snap) => {
                let d;
                try { d = snap.val(); } catch(e) { console.error('Room read error:', e); return; }
                if (!d) {
                    localStorage.removeItem('currentRoom');
                    localStorage.removeItem('isHost');
                    window.location.href = 'index.html'; return;
                }

                // Restore from idle
                if (d.players && toArray(d.players).includes(`${myName} (Ø®Ø§Ù…Ù„)`)) {
                    let restored = toArray(d.players).map(p => p === `${myName} (Ø®Ø§Ù…Ù„)` ? myName : p);
                    update(ref(db, 'rooms/' + myRoom), { players: restored }); return;
                }

                if (!toArray(d.players).includes(myName)) {
                    alert("ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ø§Ù„ØºØ±ÙØ©");
                    localStorage.removeItem('currentRoom');
                    localStorage.removeItem('isHost');
                    window.location.href = 'index.html'; return;
                }

                // Build profile cache so name tags show in all stages
                await buildPlayerProfileCache(toArray(d.players));

                document.getElementById('displayRoomCode').innerText = myRoom;
                const pCount = toArray(d.players).length;
                document.getElementById('pCount').innerText = `${pCount}/10`;
                isHost = (d.host === myName);

                // â”€â”€ Host controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (isHost) {
                    document.getElementById('host-controls').classList.remove('hidden');
                    document.getElementById('hostStartBtn').classList.remove('hidden');
                    document.getElementById('guestWaitMsg').classList.add('hidden');
                    const startBtn = document.getElementById('hostStartBtn');
                    const msg      = document.getElementById('minPlayersMsg');
                    if (pCount >= 3) { startBtn.disabled = false; msg.classList.add('hidden'); }
                    else             { startBtn.disabled = true;  msg.classList.remove('hidden'); }
                    const vBtn = document.getElementById('toggleVisibility');
                    vBtn.innerHTML = d.visibility === 'public'
                        ? '<i class="fas fa-globe mr-1"></i> Ø¹Ø§Ù…'
                        : '<i class="fas fa-lock mr-1"></i> Ø®Ø§Øµ';
                    vBtn.className = d.visibility === 'public'
                        ? "text-xs px-4 py-1.5 rounded-full border-2 border-green-500 text-green-400 font-bold hover:bg-green-500/10"
                        : "text-xs px-4 py-1.5 rounded-full border-2 border-red-500 text-red-400 font-bold hover:bg-red-500/10";
                    // Sync host dropdown with room category
                    if (d.category) {
                        const sel = document.getElementById('updateCat');
                        if (sel) sel.value = d.category;
                    }
                } else {
                    document.getElementById('host-controls').classList.add('hidden');
                    document.getElementById('hostStartBtn').classList.add('hidden');
                    document.getElementById('guestWaitMsg').classList.remove('hidden');
                    document.getElementById('minPlayersMsg').classList.add('hidden');
                }

                // â”€â”€ WAITING ROOM â€” player list with name tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                document.getElementById('roomPlayersList').innerHTML = toArray(d.players).map(p => {
                    const isMe       = p === myName;
                    const isTargetHost = p === d.host;
                    const isIdle     = p.includes('(Ø®Ø§Ù…Ù„)');
                    return `
                        <div class="flex justify-between items-center p-3 glass rounded-xl border border-cyan-500/20 hover:border-cyan-500/40 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${isTargetHost ? 'ğŸ‘‘' : isIdle ? 'ğŸ’¤' : 'ğŸ‘¤'}</span>
                                ${getPlayerHTML(p, { isHost: isTargetHost, isMe, isIdle })}
                            </div>
                            ${isHost && !isMe ? `
                                <button onclick="kickPlayer('${p}')"
                                    class="text-[10px] bg-red-600/20 hover:bg-red-600/40 text-red-400 px-3 py-1.5 rounded-lg font-bold border border-red-500/30 transition-all">
                                    Ø·Ø±Ø¯
                                </button>` : ''}
                        </div>`;
                }).join('');

                // â”€â”€ Route to correct game screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (d.status && d.status !== 'waiting') {
                    hideAllGameScreens();
                    if      (d.status === 'playing')   showOnlineGame(d);
                    else if (d.status === 'discussion') showDiscussionScreen(d);
                    else if (d.status === 'voting')    showVotingScreen(d);
                    else if (d.status === 'tie')       showTieScreen(d);
                    else if (d.status === 'spinner')   showSpinnerScreen(d);
                    else if (d.status === 'spy_guess') showSpyGuessScreen(d);
                    else if (d.status === 'result')    showResultScreen(d);
                } else {
                    hideAllGameScreens();
                    document.getElementById('room-overlay').classList.remove('hidden');
                }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ROOM ACTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function handleLeave(data, nameToLeave) {
            let players = toArray(data.players).filter(p => p !== nameToLeave);
            if (players.length === 0) {
                await remove(ref(db, 'rooms/' + myRoom));
            } else {
                let updates = { players };
                if (data.host === nameToLeave) updates.host = players[Math.floor(Math.random() * players.length)];
                await update(ref(db, 'rooms/' + myRoom), updates);
            }
        }

        window.kickPlayer = async (targetName) => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            if (snap.exists()) {
                const newPlayers = toArray(snap.val().players).filter(p => p !== targetName);
                await update(ref(db, 'rooms/' + myRoom), { players: newPlayers });
            }
        };

        document.getElementById('leaveRoomBtn').onclick = async () => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            if (snap.exists()) await handleLeave(snap.val(), myName);
            localStorage.removeItem('currentRoom');
            localStorage.removeItem('isHost');
            window.location.href = 'index.html';
        };

        window.toggleRoomVisibility = async () => {
            const s = await get(ref(db, 'rooms/' + myRoom));
            update(ref(db, 'rooms/' + myRoom), { visibility: s.val().visibility === 'private' ? 'public' : 'private' });
        };

        window.updateRoomSettings = () => {
            update(ref(db, 'rooms/' + myRoom), { category: document.getElementById('updateCat').value });
        };

        document.getElementById('hostStartBtn').onclick = async () => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d = snap.val();
            if (d.status && d.status !== 'waiting') { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©'); return; }
            // Pick secret from gameData â€” includes custom categories
            const catWords = gameData[d.category];
            if (!catWords || !catWords.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©'); return; }
            const secret = catWords[Math.floor(Math.random() * catWords.length)];
            const players = toArray(d.players);
            const spyCount = players.length >= 12 ? 3 : players.length >= 8 ? 2 : 1;
            const spyIndices = [];
            while (spyIndices.length < spyCount) {
                const idx = Math.floor(Math.random() * players.length);
                if (!spyIndices.includes(idx)) spyIndices.push(idx);
            }
            update(ref(db, 'rooms/' + myRoom), {
                status: 'playing', secret, spyIdx: spyIndices[0], spyIndices, spyCount, turn: 0,
                suspects: {}, discussionMessages: [], readyForVote: [], votes: {},
                tiedPlayers: null, spyGuess: null, winner: null, votedPlayer: null, hints: {}
            });
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STAGE 1 â€” REVEAL (turn-based card)
        // Name tag shown above the card for whose turn it is
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showOnlineGame(d) {
            hideAllGameScreens();
            document.getElementById('game-screen').classList.remove('hidden');
            const players    = toArray(d.players);
            const curName    = players[d.turn];
            const isMyTurn   = curName === myName;
            const spyIndices = d.spyIndices || [d.spyIdx];

            // Show current player name with theme
            document.getElementById('targetPlayer').textContent = '';
            document.getElementById('targetPlayerWrap').innerHTML =
                getPlayerHTML(curName, {
                    isHost: curName === d.host,
                    isMe:   isMyTurn,
                    large:  true,
                });

            const card = document.getElementById('secretCard');
            const btn  = document.getElementById('nextBtn');
            card.classList.remove('reveal-spy','reveal-innocent');
            card.innerHTML = `<i class="fas fa-fingerprint text-7xl mb-4 opacity-20"></i><p class="font-bold opacity-50 text-lg">Ø§Ù†Ù‚Ø± Ù„Ù„ÙƒØ´Ù ğŸ”’</p>`;
            card.style.pointerEvents = isMyTurn ? 'auto' : 'none';
            btn.classList.add('hidden');

            card.onclick = () => {
                const myIdx = players.indexOf(myName);
                if (spyIndices.includes(myIdx)) {
                    card.classList.add('reveal-spy');
                    card.innerHTML = `<i class="fas fa-user-secret text-8xl mb-4"></i><h2 class="text-4xl font-black italic">Ø¬Ø§Ø³ÙˆØ³ ğŸ•µï¸</h2>`;
                    if (window.SND)            SND.announce?.spyReveal?.();
                    if (window.particleSystem) particleSystem.spyReveal?.();
                } else {
                    card.classList.add('reveal-innocent');
                    card.innerHTML = `<i class="fas fa-key text-6xl mb-4"></i><p class="text-[10px] opacity-70">Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©</p><h2 class="text-3xl font-black">${d.secret}</h2>`;
                    if (window.SND)            SND.announce?.innocentReveal?.();
                    if (window.particleSystem) particleSystem.innocentReveal?.();
                }
                btn.classList.remove('hidden');
                card.onclick = null;
            };

            btn.onclick = () => {
                if (d.turn + 1 >= players.length) {
                    update(ref(db, 'rooms/' + myRoom), {
                        status: 'discussion', suspects: {}, discussionMessages: [], readyForVote: [], votes: {}
                    });
                } else {
                    update(ref(db, 'rooms/' + myRoom), { turn: d.turn + 1 });
                }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STAGE 2 â€” DISCUSSION  (suspect cards with name tags)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showDiscussionScreen(d) {
            hideAllGameScreens();
            document.getElementById('discussion-screen').classList.remove('hidden');

            if (typeof loadHintBalance === 'function') loadHintBalance();
            showRoomHints(d);

            const players = toArray(d.players);
            document.getElementById('suspectsList').innerHTML = players.map(p => {
                const suspectCount = d.suspects?.[p]?.length || 0;
                const isSuspect    = d.suspects?.[p]?.includes(myName);
                const cleanName    = p.replace(' (Ø®Ø§Ù…Ù„)', '').trim();
                return `
                    <div class="glass rounded-2xl p-4 border-2 ${isSuspect ? 'border-red-500' : 'border-cyan-500/30'} text-center hover:border-cyan-500/60 transition-all">
                        <div class="text-3xl mb-2">${p === d.host ? 'ğŸ‘‘' : 'ğŸ‘¤'}</div>
                        <div class="flex justify-center mb-2">
                            ${getPlayerHTML(p, { isHost: p === d.host, isMe: p === myName })}
                        </div>
                        <div class="text-xs opacity-60 mb-3">${suspectCount} Ø´Ø®Øµ ÙŠØ´Ùƒ Ø¨Ù‡</div>
                        <button onclick="toggleSuspect('${cleanName}')"
                            class="${isSuspect ? 'bg-red-600 hover:bg-red-700' : 'bg-white/10 hover:bg-white/20'} w-full py-2 rounded-lg text-xs font-bold transition-all border-2 ${isSuspect ? 'border-red-400' : 'border-white/20'}">
                            ${isSuspect ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ùƒ âŒ' : 'Ø£Ø´Ùƒ Ø¨Ù‡ ğŸ”'}
                        </button>
                    </div>`;
            }).join('');

            if (d.discussionMessages) {
                const messagesDiv = document.getElementById('discussionMessages');
                messagesDiv.innerHTML = d.discussionMessages.map(m =>
                    `<div class="mb-2"><span class="font-bold text-cyan-400">${m.player}:</span> ${m.msg}</div>`
                ).join('');
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            const readyCount = d.readyForVote?.length || 0;
            document.getElementById('discussionInfo').innerText = `${readyCount}/${players.length} Ù„Ø§Ø¹Ø¨ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØµÙˆÙŠØª`;

            const goVoteBtn = document.getElementById('goVoteBtn');
            const isReady   = d.readyForVote?.includes(myName);
            goVoteBtn.innerText = isReady ? 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†... â³' : 'Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØµÙˆÙŠØª âœ…';
            goVoteBtn.disabled  = isReady;
            goVoteBtn.onclick   = markReadyForVote;
        }

        window.toggleSuspect = async (targetCleanName) => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d    = snap.val();
            let suspects = d.suspects || {};
            // Find the actual player name (may include Ø®Ø§Ù…Ù„ suffix)
            const actual = toArray(d.players).find(p => p.replace(' (Ø®Ø§Ù…Ù„)','').trim() === targetCleanName) || targetCleanName;
            if (!suspects[actual]) suspects[actual] = [];
            if (suspects[actual].includes(myName)) {
                suspects[actual] = suspects[actual].filter(p => p !== myName);
            } else {
                suspects[actual].push(myName);
            }
            update(ref(db, 'rooms/' + myRoom), { suspects });
        };

        async function markReadyForVote() {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d    = snap.val();
            let ready  = d.readyForVote || [];
            if (!ready.includes(myName)) {
                ready.push(myName);
                await update(ref(db, 'rooms/' + myRoom), { readyForVote: ready });
            }
            if (ready.length >= toArray(d.players).length) {
                await update(ref(db, 'rooms/' + myRoom), { status: 'voting', votes: {} });
            }
        }

        document.getElementById('toggleChatBtn').onclick = () => document.getElementById('chatWindow').classList.toggle('hidden');
        document.getElementById('closeChatBtn').onclick  = () => document.getElementById('chatWindow').classList.add('hidden');

        document.getElementById('sendDiscussionBtn').onclick = async () => {
            const input = document.getElementById('discussionInput');
            const msg   = input.value.trim();
            if (!msg) return;
            if (window.MOD) {
                const blocked = await MOD.scan(msg);
                if (blocked) { input.value = ''; return; }
            }
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d    = snap.val();
            let messages = d.discussionMessages || [];
            messages.push({ player: myName, msg });
            await update(ref(db, 'rooms/' + myRoom), { discussionMessages: messages });
            input.value = '';
        };

        document.getElementById('discussionInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('sendDiscussionBtn').click();
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STAGE 3 â€” VOTING  (vote cards with name tags)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showVotingScreen(d) {
            if (window.SND) SND.announce?.voting?.();
            hideAllGameScreens();
            document.getElementById('voting-screen').classList.remove('hidden');

            const players  = toArray(d.players);
            const hasVoted = d.votes?.[myName];

            document.getElementById('voteCards').innerHTML = players.map(p => {
                const voteCount = Object.values(d.votes || {}).filter(v => v === p).length;
                const isMyVote  = d.votes?.[myName] === p;
                return `
                    <div class="glass rounded-2xl p-4 border-2 ${isMyVote ? 'border-yellow-500' : 'border-cyan-500/30'} text-center ${hasVoted ? 'opacity-70' : ''} hover:border-cyan-500/60 transition-all">
                        <div class="text-4xl mb-2">${p === d.host ? 'ğŸ‘‘' : 'ğŸ‘¤'}</div>
                        <div class="flex justify-center mb-2">
                            ${getPlayerHTML(p, { isHost: p === d.host, isMe: p === myName })}
                        </div>
                        <div class="text-xs opacity-60 mb-3 font-bold">${voteCount} ØµÙˆØª</div>
                        <button onclick="castVote('${p.replace(/'/g,"&#39;")}')" ${hasVoted ? 'disabled' : ''}
                            class="bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-600 disabled:cursor-not-allowed w-full py-2 rounded-lg text-xs font-bold transition-all border-2 border-yellow-400/50">
                            ${isMyVote ? 'ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª âœ“' : 'ØµÙˆÙ‘Øª ğŸ—³ï¸'}
                        </button>
                    </div>`;
            }).join('');

            const votedCount = Object.keys(d.votes || {}).length;
            document.getElementById('votingStatus').innerText = `${votedCount}/${players.length} Ù„Ø§Ø¹Ø¨ Ù‚Ø§Ù… Ø¨Ø§Ù„ØªØµÙˆÙŠØª`;
        }

        window.castVote = async (targetPlayer) => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d    = snap.val();
            if (d.votes?.[myName]) return;
            let votes = d.votes || {};
            votes[myName] = targetPlayer;
            await update(ref(db, 'rooms/' + myRoom), { votes });
            if (Object.keys(votes).length >= toArray(d.players).length) processVotes(d, votes);
        };

        async function processVotes(d, votes) {
            const voteCounts = {};
            toArray(d.players).forEach(p => voteCounts[p] = 0);
            Object.values(votes).forEach(v => { voteCounts[v] = (voteCounts[v] || 0) + 1; });
            const maxVotes = Math.max(...Object.values(voteCounts));
            const topVoted = Object.keys(voteCounts).filter(p => voteCounts[p] === maxVotes);
            if (topVoted.length > 1) {
                await update(ref(db, 'rooms/' + myRoom), { status: 'tie', tiedPlayers: topVoted });
                setTimeout(async () => { await update(ref(db, 'rooms/' + myRoom), { status: 'spinner' }); }, 2000);
            } else {
                checkGameResult(d, topVoted[0]);
            }
        }

        function showTieScreen(d) {
            hideAllGameScreens();
            document.getElementById('tie-screen').classList.remove('hidden');
            setTimeout(() => document.getElementById('tie-screen').classList.add('hidden'), 2000);
        }

        function showSpinnerScreen(d) {
            hideAllGameScreens();
            document.getElementById('spinner-screen').classList.remove('hidden');
            const spinnerContent = document.getElementById('spinnerContent');
            const startBtn       = document.getElementById('startSpinnerBtn');
            startBtn.onclick = async () => {
                startBtn.disabled = true;
                let index = 0;
                const interval = setInterval(() => {
                    spinnerContent.innerText = d.tiedPlayers[index % d.tiedPlayers.length];
                    index++;
                }, 100);
                setTimeout(async () => {
                    clearInterval(interval);
                    const selected = d.tiedPlayers[Math.floor(Math.random() * d.tiedPlayers.length)];
                    spinnerContent.innerText = selected;
                    setTimeout(() => checkGameResult(d, selected), 1500);
                }, 3000);
            };
        }

        async function checkGameResult(d, votedPlayer) {
            const spyName = d.players[d.spyIdx];
            if (votedPlayer === spyName) {
                await update(ref(db, 'rooms/' + myRoom), { status: 'spy_guess', votedPlayer: spyName });
            } else {
                await update(ref(db, 'rooms/' + myRoom), { status: 'result', winner: 'spy', spyName });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STAGE 4 â€” SPY GUESS  (uses live gameData including custom categories)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showSpyGuessScreen(d) {
            hideAllGameScreens();
            document.getElementById('spy-guess-screen').classList.remove('hidden');

            const spyIndices = d.spyIndices || [d.spyIdx];
            const spyNames   = spyIndices.map(i => toArray(d.players)[i]).filter(Boolean);
            const spyName    = spyNames[0] || toArray(d.players)[d.spyIdx];

            document.getElementById('spyNameDisplay').innerHTML = spyNames.length > 1
                ? `Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³ Ù‡Ù…: <strong>${spyNames.join(' Ùˆ ')}</strong>`
                : `Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ù‡Ùˆ: <strong>${spyName}</strong>`;

            // â˜… FIX: use dynamic gameData (includes custom categories)
            const categoryWords = gameData[d.category] || [];
            const wordsList = document.getElementById('categoryWordsList');
            const isSpy     = spyNames.includes(myName);
            const hasGuessed = d.spyGuess !== undefined && d.spyGuess !== null;

            if (categoryWords.length === 0) {
                wordsList.innerHTML = '<p class="text-red-400 col-span-3">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</p>';
            } else {
                wordsList.innerHTML = categoryWords.map(word => `
                    <button onclick="spyGuessWord('${word.replace(/'/g,"&#39;")}')"
                        ${!isSpy || hasGuessed ? 'disabled' : ''}
                        class="glass rounded-xl p-3 border-2 border-cyan-500/30 font-bold text-sm hover:border-cyan-500 disabled:opacity-30 transition-all text-right">
                        ${word}
                    </button>`).join('');
            }

            if (hasGuessed) {
                const correct = d.spyGuess === d.secret;
                document.getElementById('guessResult').innerHTML = correct
                    ? '<span class="text-green-500">âœ“ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ÙŠÙÙˆØ²!</span>'
                    : `<span class="text-red-500">âœ— Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ§Ù†Øª: <strong>${d.secret}</strong></span>`;
            }
        }

        window.spyGuessWord = async (word) => {
            const snap = await get(ref(db, 'rooms/' + myRoom));
            const d    = snap.val();
            const correct = word === d.secret;
            await update(ref(db, 'rooms/' + myRoom), {
                spyGuess: word, status: 'result',
                winner: correct ? 'spy' : 'innocents',
                spyName: toArray(d.players)[d.spyIdx]
            });
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STAGE 5 â€” RESULT SCREEN  (player summary with roles + name tags)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showResultScreen(d) {
            setTimeout(() => {
                if (window.SND) {
                    d.winner === 'spy' ? SND.announce?.spyWins?.() : SND.announce?.innocentsWin?.();
                }
                if (window.particleSystem) particleSystem.victoryConfetti?.();
                setTimeout(() => {
                    if (window.SS) {
                        const myIdx    = toArray(d.players).indexOf(myName);
                        const spyIdxs  = d.spyIndices || [d.spyIdx];
                        SS.capture({
                            winner: d.winner, word: d.secret, category: d.category,
                            players: toArray(d.players).map((name, i) => ({ name, role: spyIdxs.includes(i) ? 'spy' : 'innocent' })),
                            myName, myRole: spyIdxs.includes(myIdx) ? 'spy' : 'innocent',
                            myWon: (d.winner === 'spy' && spyIdxs.includes(myIdx)) || (d.winner === 'innocents' && !spyIdxs.includes(myIdx))
                        });
                    }
                }, 2000);
            }, 500);

            hideAllGameScreens();
            document.getElementById('result-screen').classList.remove('hidden');

            const spyIndices = d.spyIndices || [d.spyIdx];
            const spyNames   = spyIndices.map(i => toArray(d.players)[i]).filter(Boolean);

            // Result header
            if (d.winner === 'spy') {
                document.getElementById('resultIcon').innerText  = 'ğŸ•µï¸';
                document.getElementById('resultTitle').innerText = 'Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø§Ù†ØªØµØ±!';
                document.getElementById('resultMessage').innerText = `${d.spyName} Ù†Ø¬Ø­ ÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø©! Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ§Ù†Øª: ${d.secret}`;
            } else {
                document.getElementById('resultIcon').innerText  = 'ğŸ†';
                document.getElementById('resultTitle').innerText = 'Ø§Ù„Ø£Ø¨Ø±ÙŠØ§Ø¡ Ø§Ù†ØªØµØ±ÙˆØ§!';
                document.getElementById('resultMessage').innerText = `ØªÙ… ÙƒØ´Ù Ø§Ù„Ø¬Ø§Ø³ÙˆØ³! Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ§Ù†Øª: ${d.secret}`;
            }

            // â˜… Player list with roles + name tags in result screen
            const players = toArray(d.players);
            document.getElementById('resultPlayerList').innerHTML = players.map((p, i) => {
                const isSpy  = spyIndices.includes(i);
                const won    = (d.winner === 'spy' && isSpy) || (d.winner === 'innocents' && !isSpy);
                return `
                    <div class="flex items-center gap-2 p-2 rounded-xl border ${isSpy ? 'border-red-500/50 bg-red-500/08' : 'border-green-500/30 bg-green-500/05'}">
                        <span class="text-lg">${isSpy ? 'ğŸ•µï¸' : 'ğŸ˜‡'}</span>
                        <div class="flex-1">
                            ${getPlayerHTML(p, { isHost: p === d.host, isMe: p === myName })}
                        </div>
                        <span class="text-[10px] font-bold px-2 py-1 rounded-lg ${isSpy ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">
                            ${isSpy ? 'Ø¬Ø§Ø³ÙˆØ³' : 'Ø¨Ø±ÙŠØ¡'}
                        </span>
                        <span style="font-size:14px;">${won ? 'âœ…' : 'âŒ'}</span>
                    </div>`;
            }).join('');

            updatePlayerStats(d);

            document.getElementById('returnToRoomBtn').onclick = async () => {
                hideAllGameScreens();
                await update(ref(db, 'rooms/' + myRoom), {
                    status: 'waiting', turn: 0, secret: null, spyIdx: null, spyIndices: null,
                    suspects: {}, discussionMessages: [], readyForVote: [], votes: {},
                    tiedPlayers: null, spyGuess: null, winner: null, votedPlayer: null, hints: {}
                });
                document.getElementById('room-overlay').classList.remove('hidden');
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RANKS + STATS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const RANKS = [
            { name:'Bronze',   min:0,     max:999,      css:'rank-bronze'   },
            { name:'Silver',   min:1000,  max:2499,     css:'rank-silver'   },
            { name:'Gold',     min:2500,  max:4999,     css:'rank-gold'     },
            { name:'Platinum', min:5000,  max:9999,     css:'rank-platinum' },
            { name:'Diamond',  min:10000, max:Infinity, css:'rank-diamond'  }
        ];
        function getRank(pts) { return RANKS.find(r => pts >= r.min && pts <= r.max) || RANKS[0]; }

        const ACHIEVEMENTS = {
            firstWin:       { name:'Ø§Ù„ÙÙˆØ² Ø§Ù„Ø£ÙˆÙ„',   check: s => (s.spyWins+s.innocentWins) >= 1 },
            masterDeceiver: { name:'Ø®Ø¨ÙŠØ± Ø§Ù„Ø®Ø¯Ø§Ø¹',    check: s => s.spyWins >= 10              },
            eagleEye:       { name:'Ø¹ÙŠÙ† Ø§Ù„ØµÙ‚Ø±',      check: s => (s.correctVotes||0) >= 5     },
            centuryClub:    { name:'Ù†Ø§Ø¯ÙŠ Ø§Ù„Ù…Ø¦Ø©',     check: s => s.totalGames >= 100          },
            hotStreak:      { name:'Ø³Ù„Ø³Ù„Ø© Ù†Ø§Ø±ÙŠØ©',    check: s => (s.currentStreak||0) >= 5   },
            diamondPlayer:  { name:'Ù„Ø§Ø¹Ø¨ Ø£Ù„Ù…Ø§Ø³ÙŠ',   check: (s,pts) => pts >= 10000           }
        };

        async function updatePlayerStats(gameData_result) {
            if (!firebase_auth_user) return;
            const uid     = firebase_auth_user.uid;
            const players = toArray(gameData_result.players);
            const myIdx   = players.indexOf(myName);
            if (myIdx === -1) return;
            const spyIndices = gameData_result.spyIndices || [gameData_result.spyIdx];
            const isSpy  = spyIndices.includes(myIdx);
            const won    = (isSpy && gameData_result.winner === 'spy') || (!isSpy && gameData_result.winner === 'innocents');
            const category = gameData_result.category || 'Ø¹Ø§Ù…';

            const snap = await get(ref(db, `players/${uid}`));
            const data = snap.exists() ? snap.val() : {};
            const s    = data.stats   || {};
            const currentPts = data.rankPoints || 0;

            const newStats = {
                totalGames:       (s.totalGames       || 0) + 1,
                spyWins:          (s.spyWins          || 0) + (isSpy && won ? 1 : 0),
                innocentWins:     (s.innocentWins     || 0) + (!isSpy && won ? 1 : 0),
                spyGames:         (s.spyGames         || 0) + (isSpy ? 1 : 0),
                timesCaughtAsSpy: (s.timesCaughtAsSpy || 0) + (isSpy && !won ? 1 : 0),
                currentStreak:    won ? (s.currentStreak || 0) + 1 : 0,
                longestWinStreak: Math.max(s.longestWinStreak || 0, won ? (s.currentStreak || 0) + 1 : 0),
                lastPlayed:       Date.now()
            };

            let coinsEarned = 5;
            if (won) coinsEarned += isSpy ? 50 : 20;
            if (newStats.currentStreak >= 3) coinsEarned += newStats.currentStreak * 5;
            const newCoins = (data.coins || 0) + coinsEarned;

            let ptsEarned = 10;
            if (won) ptsEarned += isSpy ? 100 : 50;
            if (newStats.currentStreak > 1) ptsEarned += newStats.currentStreak * 10;
            const newPts  = currentPts + ptsEarned;
            const newRank = getRank(newPts);
            const oldRank = getRank(currentPts);

            const catStats = data.categoryStats || {};
            catStats[category] = (catStats[category] || 0) + 1;

            const history = data.gameHistory || [];
            history.push({ role: isSpy?'spy':'innocent', won, category, timestamp: Date.now() });
            if (history.length > 50) history.splice(0, history.length - 50);

            const unlocked       = data.achievements || {};
            const newlyUnlocked  = [];
            for (const [id, ach] of Object.entries(ACHIEVEMENTS)) {
                if (!unlocked[id] && ach.check(newStats, newPts)) {
                    unlocked[id] = { timestamp: Date.now() };
                    newlyUnlocked.push(ach.name);
                    coinsEarned += 100;
                }
            }

            const updates = {};
            updates[`players/${uid}/stats`]         = newStats;
            updates[`players/${uid}/coins`]         = newCoins;
            updates[`players/${uid}/rankPoints`]    = newPts;
            updates[`players/${uid}/rank`]          = newRank.name;
            updates[`players/${uid}/categoryStats`] = catStats;
            updates[`players/${uid}/gameHistory`]   = history;
            updates[`players/${uid}/achievements`]  = unlocked;
            await update(ref(db), updates);

            setTimeout(() => {
                if (window.SND) SND.announce?.coinsEarned?.(coinsEarned);
                showToast(`ğŸª™ +${coinsEarned} Ø¹Ù…Ù„Ø©  â€¢  +${ptsEarned} Ù†Ù‚Ø·Ø© Ø±ØªØ¨Ø©`);
                if (newRank.name !== oldRank.name) {
                    if (window.SND) SND.announce?.rankUp?.(newRank.name);
                    if (window.particleSystem) particleSystem.burst?.(40, 'particle-victory');
                    setTimeout(() => showToast(`ğŸ‰ ØªØ±Ù‚ÙŠØ©! Ø£ØµØ¨Ø­Øª ${newRank.name}`), 2000);
                }
                newlyUnlocked.forEach((name, i) => {
                    setTimeout(() => {
                        if (window.SND) SND.announce?.achievement?.(name);
                        showToast(`ğŸ† Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯: ${name}`);
                    }, (i + 1) * 3000);
                });
            }, 1500);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ROOM CODE COPY + QR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.getElementById('roomCodeContainer').onclick = () => {
            navigator.clipboard.writeText(myRoom)
                .then(() => showToast('ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯: ' + myRoom))
                .catch(() => {});
        };

        const qrShareEl = document.getElementById('roomCodeContainer');
        if (qrShareEl) {
            const qrBtn = document.createElement('button');
            qrBtn.innerHTML = 'ğŸ“²';
            qrBtn.title     = 'Ù…Ø´Ø§Ø±ÙƒØ© QR';
            qrBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:18px;margin-right:6px;';
            qrBtn.onclick = (e) => { e.stopPropagation(); if (window.QR) QR.generate(myRoom); };
            qrShareEl.appendChild(qrBtn);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VOICE CHAT  (onChildAdded now imported correctly)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        setTimeout(() => {
            if (window.VoiceChat && firebase_auth_user) {
                window._firebaseFns = { ref, get, update, onValue, push, serverTimestamp, onChildAdded };
                window.VC = new VoiceChat(db, myRoom, firebase_auth_user.uid, myName);
            }
        }, 2000);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HINT SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadHintBalance() {
            if (!firebase_auth_user) return;
            const snap = await get(ref(db, `players/${firebase_auth_user.uid}/hints`));
            document.getElementById('hintBalance').innerText = snap.val() || 0;
        }
        window.loadHintBalance = loadHintBalance;

        window.useHint = async function() {
            if (!firebase_auth_user) { alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return; }
            const snap = await get(ref(db, `players/${firebase_auth_user.uid}/hints`));
            const bal  = snap.val() || 0;
            if (bal < 1) { alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØªÙ„Ù…ÙŠØ­Ø§Øª! Ø§Ø´ØªØ±Ù Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±.'); return; }
            const roomSnap = await get(ref(db, 'rooms/' + myRoom));
            const d = roomSnap.val();
            if (!d) return;
            const spyIndices = d.spyIndices || [d.spyIdx];
            const spyNames   = spyIndices.map(i => toArray(d.players)[i]);
            const innocents  = toArray(d.players).filter((_, i) => !spyIndices.includes(i));
            const hintTypes = [
                () => `Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³: ${spyNames.length}`,
                () => `Ù„ÙŠØ³ "${innocents[Math.floor(Math.random() * innocents.length)]}" Ø¬Ø§Ø³ÙˆØ³Ø§Ù‹`,
                () => `Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ© ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù "${d.secret ? d.secret[0] : '?'}"`,
                () => `Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ù„ÙŠØ³ Ø§Ù„Ù…Ø¶ÙŠÙ ${d.host === myName ? '(Ù‡Ø°Ø§ Ø£Ù†Øª)' : ''}`,
                () => `Ø·ÙˆÙ„ Ø§Ù„ÙƒÙ„Ù…Ø©: ${d.secret ? d.secret.length : '?'} Ø­Ø±Ù`,
            ];
            const hint = hintTypes[Math.floor(Math.random() * hintTypes.length)]();
            await update(ref(db, `players/${firebase_auth_user.uid}`), { hints: bal - 1 });
            document.getElementById('hintBalance').innerText = bal - 1;
            document.getElementById('hint-display').classList.remove('hidden');
            document.getElementById('hint-text').innerText = hint;
            await update(ref(db, 'rooms/' + myRoom), {
                [`hints/${firebase_auth_user.uid}`]: { hint, usedAt: Date.now(), by: myName }
            });
            if (window.SND) SND.play?.('coins');
        };

        function showRoomHints(d) {
            if (!d.hints) return;
            const vals = Object.values(d.hints);
            if (!vals.length) return;
            const last = vals[vals.length - 1];
            document.getElementById('hint-display').classList.remove('hidden');
            document.getElementById('hint-text').innerText = `${last.hint}  (Ù…Ù† ${last.by || 'Ù„Ø§Ø¹Ø¨'})`;
        }
    </script>

    <script>
        window.alert   = (msg)             => typeof UIAlert   === 'function' ? UIAlert(msg)           : window._origAlert(msg);
        window.confirm = (msg)             => typeof UIConfirm  === 'function' ? UIConfirm(msg)          : window._origConfirm(msg);
        window.prompt  = (msg, def)        => typeof UIPrompt   === 'function' ? UIPrompt(msg,{defaultValue:def}) : window._origPrompt(msg,def);
        window._origAlert   = window._origAlert   || alert;
        window._origConfirm = window._origConfirm || confirm;
        window._origPrompt  = window._origPrompt  || prompt;
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js').catch(() => {}));
        }
    </script>
</body>
</html>