<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø¬Ø§Ø³ÙˆØ³">
    <meta name="theme-color" content="#0a0e1a">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ØªØ¬Ø± | El Jasus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="ElJasus2.png">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="mobile.css">
    <style>
        :root { --primary:#00f2ff; --secondary:#7c30ff; }
        body { font-family:'Cairo',sans-serif; background:linear-gradient(135deg,#0a0e1a 0%,#1a1535 50%,#0f0c1d 100%);
            background-attachment:fixed; color:#fff; min-height:100vh; overflow-x:hidden; }
        body::before { content:''; position:fixed; inset:0;
            background-image:linear-gradient(rgba(0,242,255,.03) 1px,transparent 1px),
            linear-gradient(90deg,rgba(0,242,255,.03) 1px,transparent 1px);
            background-size:50px 50px; animation:gridMove 20s linear infinite; pointer-events:none; z-index:0; }
        @keyframes gridMove { to { transform:translateY(50px); } }
        .glass { background:linear-gradient(135deg,rgba(15,20,35,.92),rgba(25,30,50,.85));
            backdrop-filter:blur(20px); border:2px solid; position:relative; overflow:hidden;
            border-image:linear-gradient(135deg,rgba(0,242,255,.3),rgba(124,48,255,.3)) 1;
            box-shadow:0 8px 32px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.07); }
        .neon { font-family:'Orbitron',sans-serif; text-shadow:0 0 10px rgba(0,242,255,.8),0 0 20px rgba(0,242,255,.5); }

        /* Coin display */
        .coin-badge { background:linear-gradient(135deg,rgba(255,215,0,.2),rgba(255,165,0,.1));
            border:2px solid rgba(255,215,0,.5); border-radius:30px; padding:8px 20px;
            display:inline-flex; align-items:center; gap:8px;
            box-shadow:0 0 20px rgba(255,215,0,.3); }
        .coin-icon { font-size:22px; animation:coinSpin 4s linear infinite; }
        @keyframes coinSpin { 50%{transform:rotateY(180deg);} }

        /* Shop cards */
        .shop-card { border-radius:20px; transition:all .3s; cursor:pointer; }
        .shop-card:hover { transform:translateY(-6px); }
        .shop-card.owned { opacity:.6; pointer-events:none; }

        /* Theme previews */
        .theme-cyan    { background:linear-gradient(135deg,#00f2ff,#0080ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .theme-red     { background:linear-gradient(135deg,#ff4444,#ff0080); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .theme-gold    { background:linear-gradient(135deg,#ffd700,#ff8c00); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .theme-green   { background:linear-gradient(135deg,#00ff88,#00cc44); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .theme-purple  { background:linear-gradient(135deg,#cc00ff,#7c30ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .theme-rainbow { background:linear-gradient(135deg,#ff0000,#ff7700,#ffff00,#00ff00,#0000ff,#8b00ff);
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; animation:rainbowShift 3s linear infinite; }
        @keyframes rainbowShift { 0%{filter:hue-rotate(0deg)} 100%{filter:hue-rotate(360deg)} }
        .theme-fire    { background:linear-gradient(135deg,#ff6b00,#ff0000,#ffcc00); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .theme-ice     { background:linear-gradient(135deg,#a8edea,#fed6e3,#e0c3fc); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }

        .tab-btn { border-radius:12px; padding:10px 20px; font-weight:900; font-size:13px;
            text-transform:uppercase; letter-spacing:1px; transition:all .3s; border:2px solid transparent; }
        .tab-btn.active { background:linear-gradient(135deg,var(--primary),var(--secondary));
            box-shadow:0 0 20px rgba(0,242,255,.4); }
        .badge-new { background:#ef4444; color:white; font-size:9px; font-weight:900;
            padding:2px 6px; border-radius:10px; vertical-align:top; margin-right:4px; }
    </style>
</head>
<body class="p-4 has-mobile-nav">

<div class="max-w-5xl mx-auto relative z-10">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <a href="index.html" class="flex items-center gap-2 text-gray-400 hover:text-cyan-400 transition-all">
            <i class="fas fa-arrow-right text-xl"></i>
            <span class="text-sm font-bold">Ø±Ø¬ÙˆØ¹</span>
        </a>
        <div class="text-center">
            <h1 class="text-3xl font-black neon uppercase">Ø§Ù„Ù…ØªØ¬Ø±</h1>
            <p style="font-family:'Orbitron',sans-serif;font-size:10px;color:#555;letter-spacing:3px;">SHOP</p>
        </div>
        <!-- Coin balance -->
        <div class="coin-badge">
            <span class="coin-icon">ğŸª™</span>
            <span id="coinBalance" style="font-family:'Orbitron',sans-serif;font-weight:900;font-size:18px;color:#ffd700;">0</span>
        </div>
    </div>

    <!-- Earn coins info -->
    <div class="glass rounded-2xl p-5 mb-6" style="border-image:linear-gradient(135deg,rgba(255,215,0,.4),rgba(255,165,0,.2)) 1;">
        <div class="flex items-center gap-4 flex-wrap">
            <span style="font-size:32px;">ğŸª™</span>
            <div class="flex-1">
                <h3 class="font-black text-yellow-400 text-lg mb-1">ÙƒÙŠÙ ØªÙƒØ³Ø¨ Ø¹Ù…Ù„Ø§ØªØŸ</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-2">
                    <div class="text-center p-2 rounded-xl" style="background:rgba(255,215,0,.08)">
                        <p style="font-family:'Orbitron',sans-serif;color:#ffd700;font-size:16px;font-weight:900;">+20</p>
                        <p class="text-xs text-gray-400">ÙÙˆØ² ÙƒØ¨Ø±ÙŠØ¡</p>
                    </div>
                    <div class="text-center p-2 rounded-xl" style="background:rgba(255,215,0,.08)">
                        <p style="font-family:'Orbitron',sans-serif;color:#ffd700;font-size:16px;font-weight:900;">+50</p>
                        <p class="text-xs text-gray-400">ÙÙˆØ² ÙƒØ¬Ø§Ø³ÙˆØ³</p>
                    </div>
                    <div class="text-center p-2 rounded-xl" style="background:rgba(255,215,0,.08)">
                        <p style="font-family:'Orbitron',sans-serif;color:#ffd700;font-size:16px;font-weight:900;">+10</p>
                        <p class="text-xs text-gray-400">Ù…Ø´Ø§Ø±ÙƒØ© ÙŠÙˆÙ…ÙŠØ©</p>
                    </div>
                    <div class="text-center p-2 rounded-xl" style="background:rgba(255,215,0,.08)">
                        <p style="font-family:'Orbitron',sans-serif;color:#ffd700;font-size:16px;font-weight:900;">+100</p>
                        <p class="text-xs text-gray-400">Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-3 mb-6 flex-wrap">
        <button class="tab-btn active" onclick="showTab('themes',this)">ğŸ¨ Ø«ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³Ù…</button>
        <button class="tab-btn" onclick="showTab('titles',this)">ğŸ‘‘ Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨</button>
        <button class="tab-btn" onclick="showTab('hints',this)">ğŸ’¡ ØªÙ„Ù…ÙŠØ­Ø§Øª</button>
    </div>

    <!-- USERNAME THEMES TAB -->
    <div id="tab-themes">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="themes-grid"></div>
    </div>

    <!-- TITLES TAB -->
    <div id="tab-titles" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="titles-grid"></div>
    </div>

    <!-- HINTS TAB -->
    <div id="tab-hints" class="hidden">
        <div class="glass rounded-2xl p-6">
            <div class="flex items-center gap-4 mb-6">
                <span style="font-size:48px;">ğŸ’¡</span>
                <div>
                    <h2 class="text-2xl font-black neon">Ø­Ø²Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª</h2>
                    <p class="text-gray-400 text-sm">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨ Ù„ÙƒØ´Ù Ø§Ù„Ø¬Ø§Ø³ÙˆØ³</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="hints-grid"></div>
        </div>
    </div>
</div>

<!-- Purchase Modal -->
<div id="buy-modal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
    <div class="glass rounded-3xl p-8 max-w-sm w-full text-center">
        <div id="buy-preview" class="text-6xl mb-4"></div>
        <h2 id="buy-name" class="text-2xl font-black mb-2"></h2>
        <p id="buy-desc" class="text-gray-400 text-sm mb-6"></p>
        <div class="coin-badge justify-center mb-6">
            <span>ğŸª™</span>
            <span id="buy-price" style="font-family:'Orbitron',sans-serif;font-weight:900;color:#ffd700;font-size:20px;"></span>
        </div>
        <div class="flex gap-3">
            <button id="confirm-buy" class="flex-1 py-3 rounded-xl font-black text-sm uppercase"
                style="background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;">Ø´Ø±Ø§Ø¡</button>
            <button onclick="document.getElementById('buy-modal').classList.add('hidden')"
                class="flex-1 py-3 rounded-xl font-black text-sm uppercase border-2 border-white/10 bg-white/5">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, update, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";


const firebaseConfig = {
  apiKey: "AIzaSyDnd-pmKEatI3DaFz6xHWB5ucurtHXt9tk",
  authDomain: "el-jasus.firebaseapp.com",
  databaseURL: "https://el-jasus-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "el-jasus",
  storageBucket: "el-jasus.firebasestorage.app",
  messagingSenderId: "415659587906",
  appId: "1:415659587906:web:782f7940176ea4097eb0db",
  measurementId: "G-N4K79FP56N"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
window._firebaseFns = { ref, get, update, onValue, push, serverTimestamp };

let currentUser = null;
let userData    = {};
let pendingItem = null;

// â”€â”€ CATALOGUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const THEMES = [
    { id:'cyan',    name:'Ø³Ø§ÙŠØ¨Ø± Ø³ÙŠØ§Ù†',   price:0,   preview:'Agent_007', cls:'theme-cyan',    desc:'Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ', free:true },
    { id:'red',     name:'Ø§Ù„Ø¯Ù… Ø§Ù„Ø£Ø­Ù…Ø±',   price:200, preview:'Agent_007', cls:'theme-red',     desc:'Ø£Ø­Ù…Ø± Ù‚Ø§Ù†Ù Ù…Ø´Ø¹' },
    { id:'gold',    name:'Ø°Ù‡Ø¨ÙŠ Ù…Ù„ÙƒÙŠ',    price:300, preview:'Agent_007', cls:'theme-gold',    desc:'Ø¨Ø±ÙŠÙ‚ Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ø£ØµÙØ±' },
    { id:'green',   name:'Ø¹Ù…ÙŠÙ„ Ø³Ø±ÙŠ',     price:250, preview:'Agent_007', cls:'theme-green',   desc:'Ø£Ø®Ø¶Ø± Ø¹Ù…ÙŠÙ‚ Ø³Ø§Ø·Ø¹' },
    { id:'purple',  name:'Ø§Ù„Ø£Ø±Ø¬ÙˆØ§Ù†ÙŠ',    price:350, preview:'Agent_007', cls:'theme-purple',  desc:'Ø¨Ù†ÙØ³Ø¬ÙŠ ÙƒØ«ÙŠÙ' },
    { id:'fire',    name:'Ø§Ù„Ù†Ø§Ø± ÙˆØ§Ù„Ø¯Ù…',   price:500, preview:'Agent_007', cls:'theme-fire',    desc:'Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†Ø§Ø±' },
    { id:'ice',     name:'Ø«Ù„Ø¬ Ø£Ø¨ÙŠØ¶',     price:450, preview:'Agent_007', cls:'theme-ice',     desc:'Ø¨Ø§Ø±Ø¯ÙŒ ÙƒØ§Ù„Ø¬Ù„ÙŠØ¯' },
    { id:'rainbow', name:'Ù‚ÙˆØ³ Ù‚Ø²Ø­',      price:999, preview:'Agent_007', cls:'theme-rainbow', desc:'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù† â€” Ù†Ø§Ø¯Ø±!' },
];

const TITLES = [
    { id:'spy_master',  name:'Ø³ÙŠØ¯ Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³',  price:500,  icon:'ğŸ•µï¸', desc:'Ù„Ù„Ù…Ø­ØªØ±ÙÙŠÙ† ÙÙ‚Ø·' },
    { id:'shadow',      name:'Ø§Ù„Ø¸Ù„',           price:300,  icon:'ğŸŒ‘', desc:'Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ±Ø§Ùƒ' },
    { id:'detective',   name:'Ø§Ù„Ù…Ø­Ù‚Ù‚',         price:400,  icon:'ğŸ”', desc:'Ù„Ø§ Ø´ÙŠØ¡ ÙŠÙÙˆØªÙƒ' },
    { id:'ghost',       name:'Ø§Ù„Ø´Ø¨Ø­',          price:600,  icon:'ğŸ‘»', desc:'ØªØ®ØªÙÙŠ ÙÙŠ Ø§Ù„Ø¸Ù„Ø§Ù…' },
    { id:'legend',      name:'Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©',       price:1500, icon:'ğŸ‘‘', desc:'Ù†Ø§Ø¯Ø± Ø¬Ø¯Ø§Ù‹' },
    { id:'rookie',      name:'Ø§Ù„Ù…Ø¨ØªØ¯Ø¦',        price:0,    icon:'ğŸŒ±', desc:'Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹', free:true },
];

const HINT_PACKS = [
    { id:'hints_3',  name:'3 ØªÙ„Ù…ÙŠØ­Ø§Øª', price:50,  hints:3,  icon:'ğŸ’¡', desc:'ÙƒØ§ÙÙ Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ÙˆØ§Ø­Ø¯Ø©' },
    { id:'hints_10', name:'10 ØªÙ„Ù…ÙŠØ­Ø§Øª',price:150, hints:10, icon:'ğŸ”¦', desc:'ØµÙÙ‚Ø© Ø¬ÙŠØ¯Ø©' },
    { id:'hints_25', name:'25 ØªÙ„Ù…ÙŠØ­Ø§Ù‹',price:300, hints:25, icon:'ğŸŒŸ', desc:'Ø§Ù„Ø£ÙØ¶Ù„ Ù‚ÙŠÙ…Ø©Ù‹!' },
];

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, async user => {
    if (!user) { window.location.href = 'login.html'; return; }
    currentUser = user;
    const snap = await get(ref(db, `players/${user.uid}`));
    userData = snap.exists() ? snap.val() : {};
    document.getElementById('coinBalance').textContent = userData.coins || 0;
    renderThemes(); renderTitles(); renderHints();
});

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderThemes() {
    const grid = document.getElementById('themes-grid');
    grid.innerHTML = THEMES.map(item => {
        const owned  = item.free || (userData.inventory?.themes || []).includes(item.id);
        const active = userData.activeTheme === item.id;
        return `
        <div class="glass shop-card rounded-2xl p-5 ${owned?'':'hover:border-cyan-500/50'}" 
             onclick="${owned?`equipTheme('${item.id}')`:`openBuy('${item.id}','theme')`}">
            <div class="text-center mb-4">
                <p class="text-4xl font-black ${item.cls}" style="font-family:'Orbitron',sans-serif;">${item.preview}</p>
            </div>
            <h3 class="font-black text-lg mb-1">${item.name}</h3>
            <p class="text-xs text-gray-400 mb-4">${item.desc}</p>
            <div class="flex items-center justify-between">
                ${item.free ? `<span class="text-green-400 font-bold text-sm">Ù…Ø¬Ø§Ù†ÙŠ</span>` :
                  `<div class="flex items-center gap-2"><span>ğŸª™</span><span style="font-family:'Orbitron',sans-serif;color:#ffd700;font-weight:900;">${item.price}</span></div>`}
                <button class="px-4 py-2 rounded-xl font-black text-xs uppercase transition-all
                    ${active ? 'bg-green-500/30 border-2 border-green-500/50 text-green-400' :
                      owned  ? 'bg-cyan-500/20 border-2 border-cyan-500/30 text-cyan-400' :
                               'bg-gradient-to-r from-cyan-500 to-purple-500 text-white'}">
                    ${active?'âœ“ Ù…ÙØ¹Ù‘Ù„':owned?'ØªÙØ¹ÙŠÙ„':'Ø´Ø±Ø§Ø¡'}
                </button>
            </div>
        </div>`;
    }).join('');
}

function renderTitles() {
    const grid = document.getElementById('titles-grid');
    grid.innerHTML = TITLES.map(item => {
        const owned  = item.free || (userData.inventory?.titles || []).includes(item.id);
        const active = userData.activeTitle === item.id;
        return `
        <div class="glass shop-card rounded-2xl p-5"
             onclick="${owned?`equipTitle('${item.id}')`:`openBuy('${item.id}','title')`}">
            <div class="text-center mb-4"><span style="font-size:48px;">${item.icon}</span></div>
            <h3 class="font-black text-lg mb-1">${item.name}</h3>
            <p class="text-xs text-gray-400 mb-4">${item.desc}</p>
            <div class="flex items-center justify-between">
                ${item.free ? `<span class="text-green-400 font-bold text-sm">Ù…Ø¬Ø§Ù†ÙŠ</span>` :
                  `<div class="flex items-center gap-2"><span>ğŸª™</span><span style="font-family:'Orbitron',sans-serif;color:#ffd700;font-weight:900;">${item.price}</span></div>`}
                <button class="px-4 py-2 rounded-xl font-black text-xs uppercase
                    ${active?'bg-green-500/30 border-2 border-green-500/50 text-green-400':
                      owned ?'bg-cyan-500/20 border-2 border-cyan-500/30 text-cyan-400':
                             'bg-gradient-to-r from-cyan-500 to-purple-500 text-white'}">
                    ${active?'âœ“ Ù…ÙØ¹Ù‘Ù„':owned?'ØªÙØ¹ÙŠÙ„':'Ø´Ø±Ø§Ø¡'}
                </button>
            </div>
        </div>`;
    }).join('');
}

function renderHints() {
    const grid = document.getElementById('hints-grid');
    const currentHints = userData.hints || 0;
    grid.innerHTML = `
        <div class="glass rounded-xl p-4 col-span-full flex items-center gap-3 mb-2"
            style="border-image:linear-gradient(135deg,rgba(255,215,0,.4),transparent) 1;">
            <span style="font-size:28px;">ğŸ’¡</span>
            <div><p class="text-xs text-gray-400">Ø±ØµÙŠØ¯Ùƒ Ù…Ù† Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª</p>
            <p style="font-family:'Orbitron',sans-serif;font-size:24px;font-weight:900;color:#ffd700;">${currentHints} ØªÙ„Ù…ÙŠØ­</p></div>
        </div>` +
    HINT_PACKS.map(item => `
        <div class="glass shop-card rounded-2xl p-5 text-center" onclick="openBuy('${item.id}','hint')">
            <span style="font-size:48px;">${item.icon}</span>
            <h3 class="font-black text-xl mt-3 mb-1">${item.name}</h3>
            <p class="text-xs text-gray-400 mb-4">${item.desc}</p>
            <div class="flex items-center justify-center gap-2 mb-4">
                <span>ğŸª™</span>
                <span style="font-family:'Orbitron',sans-serif;color:#ffd700;font-weight:900;font-size:20px;">${item.price}</span>
            </div>
            <button class="w-full py-3 rounded-xl font-black text-sm uppercase"
                style="background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;">Ø´Ø±Ø§Ø¡</button>
        </div>`).join('');
}

// â”€â”€ BUY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openBuy = (id, type) => {
    const catalogue = type==='theme'?THEMES:type==='title'?TITLES:HINT_PACKS;
    const item = catalogue.find(i=>i.id===id);
    if (!item) return;
    pendingItem = { ...item, type };
    document.getElementById('buy-preview').textContent = item.icon||item.cls?'ğŸ¨':'ğŸ’¡';
    document.getElementById('buy-name').textContent    = item.name;
    document.getElementById('buy-desc').textContent    = item.desc;
    document.getElementById('buy-price').textContent   = item.price;
    document.getElementById('buy-modal').classList.remove('hidden');
};

document.getElementById('confirm-buy').onclick = async () => {
    if (!pendingItem || !currentUser) return;
    const coins = userData.coins || 0;
    if (coins < pendingItem.price) { alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø¹Ù…Ù„Ø§Øª ÙƒØ§ÙÙŠØ©!'); return; }

    const updates = {};
    updates[`players/${currentUser.uid}/coins`] = coins - pendingItem.price;

    if (pendingItem.type === 'theme') {
        const owned = userData.inventory?.themes || [];
        if (!owned.includes(pendingItem.id)) owned.push(pendingItem.id);
        updates[`players/${currentUser.uid}/inventory/themes`] = owned;
        updates[`players/${currentUser.uid}/activeTheme`] = pendingItem.id;
    } else if (pendingItem.type === 'title') {
        const owned = userData.inventory?.titles || [];
        if (!owned.includes(pendingItem.id)) owned.push(pendingItem.id);
        updates[`players/${currentUser.uid}/inventory/titles`] = owned;
        updates[`players/${currentUser.uid}/activeTitle`] = pendingItem.id;
    } else if (pendingItem.type === 'hint') {
        updates[`players/${currentUser.uid}/hints`] = (userData.hints||0) + pendingItem.hints;
    }

    await update(ref(db), updates);

    // Refresh local state
    userData.coins = coins - pendingItem.price;
    document.getElementById('coinBalance').textContent = userData.coins;
    document.getElementById('buy-modal').classList.add('hidden');

    alert(`ØªÙ… Ø´Ø±Ø§Ø¡ "${pendingItem.name}" Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰`);
    if (pendingItem.type==='theme') renderThemes();
    else if (pendingItem.type==='title') renderTitles();
    else renderHints();
};

window.equipTheme = async (id) => {
    await update(ref(db, `players/${currentUser.uid}`), { activeTheme: id });
    userData.activeTheme = id;
    renderThemes();
};
window.equipTitle = async (id) => {
    await update(ref(db, `players/${currentUser.uid}`), { activeTitle: id });
    userData.activeTitle = id;
    renderTitles();
};

window.showTab = (tab, btn) => {
    ['themes','titles','hints'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
    document.getElementById(`tab-${tab}`).classList.remove('hidden');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
};
</script>
    <link rel="stylesheet" href="mobile.css">
    <script src="sound-system.js" defer></script>
    <script src="qr-notifications.js" defer></script>
    <script src="dialogs.js"></script>
<script>
    window.alert   = (msg)             => UIAlert(msg);
    window.confirm = (msg)             => UIConfirm(msg);
    window.prompt  = (msg, defaultVal) => UIPrompt(msg, { defaultValue: defaultVal });
</script>
    <script>if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(()=>{}));}</script>
    <script src="moderation.js"></script>
</body>
</html>
